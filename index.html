<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLSEE Schedule Builder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#A51C30',
                        primaryDark: '#8B1538',
                        crimson: {
                            600: '#DC143C',
                            700: '#B91C1C'
                        }
                    },
                    fontFamily: {
                        'heading': ['Crimson Text', 'Georgia', 'Times New Roman', 'serif'],
                        'body': ['Source Sans Pro', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        .drag-over {
            background-color: rgba(165, 28, 48, 0.1) !important;
            border: 2px dashed #A51C30 !important;
        }
        .session-item, .operational-item {
            cursor: grab;
        }
        .session-item:active, .operational-item:active {
            cursor: grabbing;
        }
        .scheduled-session, .scheduled-operational {
            cursor: pointer;
        }
        .scheduled-session:hover, .scheduled-operational:hover {
            transform: scale(1.02);
        }
        .operational-item {
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen font-body">
    <div id="app" class="flex flex-col h-screen">
        <!-- Top Navigation -->
        <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img src="https://pfst.cf2.poecdn.net/base/image/b8a392c13c1ef2fca0fafb7bc133e6e788b7e52ccc6ce69d0560fcfe78fcfbb0?w=407&h=124" 
                         alt="Harvard Law School Executive Education" 
                         class="h-8 w-auto sm:h-10">
                    <div class="border-l border-gray-300 dark:border-gray-600 h-8 sm:h-10"></div>
                    <h1 class="text-lg sm:text-xl font-bold text-primary font-heading">Schedule Builder</h1>
                </div>
                <div class="flex space-x-1">
                    <button id="scheduleTab" class="nav-tab active px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-primary text-white">
                        Schedule
                    </button>
                    <button id="programsTab" class="nav-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Programs
                    </button>
                    <button id="sessionsTab" class="nav-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Session Library
                    </button>
                </div>
            </div>
        </nav>

        <div class="flex flex-1 overflow-hidden">
            <!-- Schedule View -->
            <div id="scheduleView" class="flex flex-1">
                <!-- Sidebar with programs and sessions -->
                <div class="lg:w-80 bg-gray-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 p-4 overflow-y-auto">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-primary mb-2 font-heading">Schedule Builder</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400">Select a program and drag elements to build the schedule</p>
            </div>
            
            <!-- Program Selection -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3 font-heading">Program</h2>
                <select id="programSelect" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800 mb-2">
                    <option value="">Select a program...</option>
                </select>
                <button id="newProgramBtn" class="w-full bg-primary hover:bg-primaryDark text-white px-4 py-2 rounded-lg text-base transition-colors">
                    + Create New Program
                </button>
            </div>

            <!-- Program Details -->
            <div id="programDetails" class="hidden mb-6 p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <h3 class="font-semibold mb-2">Program Details</h3>
                <div id="programInfo"></div>
            </div>
            
            <!-- Available Sessions -->
            <div id="sessionsSection" class="hidden mb-6">
                <h2 class="text-lg font-semibold mb-3">Available Sessions</h2>
                <div id="sessionsList" class="space-y-2">
                    <!-- Sessions will be populated here -->
                </div>
                <button id="addSessionBtn" class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-base transition-colors">
                    + Add Session to Program
                </button>
            </div>

            <!-- Operational Elements -->
            <div id="operationalSection" class="hidden">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold">Operational Elements</h2>
                    <div class="flex space-x-2">
                        <button id="addOperationalBtn" class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded transition-colors">
                            + Add
                        </button>
                        <button id="saveTemplateBtn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded transition-colors">
                            Save as Template
                        </button>
                    </div>
                </div>
                <div id="operationalList" class="space-y-2">
                    <!-- Operational elements will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Main calendar area -->
        <div class="flex-1 p-4 overflow-auto">
            <div class="mb-4">
                <div id="calendarHeader" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-4">
                            <h2 class="text-xl font-semibold" id="calendarTitle">Program Schedule</h2>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Year/Iteration:</label>
                                <select id="iterationDropdown" class="p-2 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-800 min-w-[150px]">
                                    <!-- Iterations will be populated here -->
                                </select>
                                <button id="newIterationDropdownBtn" class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded transition-colors">
                                    + New
                                </button>
                                <button id="editIterationDropdownBtn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded transition-colors">
                                    Rename
                                </button>
                                <button id="deleteIterationDropdownBtn" class="text-xs bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded transition-colors">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="exportPdfBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-base transition-colors flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                <span>Export PDF</span>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Drop sessions and operational elements into time slots</p>
                </div>
                <div id="noProgram" class="text-center py-12">
                    <h2 class="text-xl font-semibold text-gray-500 dark:text-gray-400 mb-2">No Program Selected</h2>
                    <p class="text-gray-500 dark:text-gray-400">Please select or create a program to start building the schedule</p>
                </div>
            </div>
            
            <div id="calendarContainer" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <!-- Calendar header -->
                <div id="calendarGridHeader"></div>
                
                <!-- Calendar grid -->
                <div id="calendarGrid">
                    <!-- Time slots will be generated here -->
                </div>
                
                <!-- Bottom utility buttons -->
                <div class="border-t border-gray-200 dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-700">
                    <div class="flex justify-center space-x-3">
                        <button id="clearScheduleBtn" class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded transition-colors">
                            Clear Schedule
                        </button>
                        <button id="debugScheduleBtn" onclick="showDebugInfo()" class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded transition-colors">
                            Debug Schedule
                        </button>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- Programs Management View -->
            <div id="programsView" class="hidden flex-1 p-6 overflow-auto">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold font-heading">Program Management</h2>
                        <div class="flex space-x-3">
                            <button id="newProgramFromManagement" class="bg-primary hover:bg-primaryDark text-white px-4 py-2 rounded-lg text-base transition-colors">
                                + Create New Program
                            </button>
                            <button id="importDataBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-base transition-colors">
                                📥 Import Data
                            </button>
                            <button id="exportDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-base transition-colors">
                                📤 Export Data
                            </button>
                            <button onclick="clearLocalStorage()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-base transition-colors">
                                🗑️ Reset Data
                            </button>
                        </div>
                    </div>
                    
                    <div id="programsList" class="space-y-4">
                        <!-- Programs will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Session Library View -->
            <div id="sessionsView" class="hidden flex-1 p-6 overflow-auto">
                <div class="max-w-4xl mx-auto">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-4 font-heading">Session Library</h2>
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="flex-1">
                                <input type="text" id="sessionSearch" placeholder="Search sessions by title, instructor, or type..." 
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800">
                            </div>
                            <select id="typeFilter" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800">
                                <option value="">All Types</option>
                                <option value="lecture">Lecture</option>
                                <option value="workshop">Workshop</option>
                                <option value="lab">Lab Session</option>
                                <option value="seminar">Seminar</option>
                                <option value="project">Project Work</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="allSessionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- All sessions will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Program Iterations Tabs -->
    <div id="iterationTabs" class="hidden bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-2">
        <div class="flex items-center space-x-2 overflow-x-auto">
            <span class="text-sm font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap">Iterations:</span>
            <div id="iterationTabsContainer" class="flex space-x-1">
                <!-- Iteration tabs will be populated here -->
            </div>
            <button id="newIterationBtn" class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded transition-colors whitespace-nowrap">
                + New Iteration
            </button>
        </div>
    </div>

    <!-- Program Edit Modal -->
    <div id="programEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Edit Program</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Program Name</label>
                    <input type="text" id="editProgramName" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Duration (Days)</label>
                    <select id="editProgramDays" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="1">1 Day</option>
                        <option value="2">2 Days</option>
                        <option value="3">3 Days</option>
                        <option value="4">4 Days</option>
                        <option value="5">5 Days (Week)</option>
                        <option value="6">6 Days</option>
                        <option value="7">7 Days</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Start Time</label>
                    <select id="editProgramStartTime" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="7">7:00 AM</option>
                        <option value="8">8:00 AM</option>
                        <option value="9">9:00 AM</option>
                        <option value="10">10:00 AM</option>
                        <option value="11">11:00 AM</option>
                        <option value="12">12:00 PM</option>
                        <option value="13">1:00 PM</option>
                        <option value="14">2:00 PM</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">End Time</label>
                    <select id="editProgramEndTime" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="12">12:00 PM</option>
                        <option value="13">1:00 PM</option>
                        <option value="14">2:00 PM</option>
                        <option value="15">3:00 PM</option>
                        <option value="16">4:00 PM</option>
                        <option value="17">5:00 PM</option>
                        <option value="18">6:00 PM</option>
                        <option value="19">7:00 PM</option>
                        <option value="20">8:00 PM</option>
                        <option value="21">9:00 PM</option>
                        <option value="22">10:00 PM</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="saveEditProgramBtn" class="flex-1 bg-primary text-white px-4 py-2 rounded text-base">Save Changes</button>
                <button id="cancelEditProgramBtn" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Iteration Title Edit Modal -->
    <div id="iterationEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Edit Iteration Title</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Iteration Title</label>
                    <input type="text" id="editIterationTitle" placeholder="e.g., Summer 2024, Fall Cohort 1" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="saveIterationTitleBtn" class="flex-1 bg-primary text-white px-4 py-2 rounded text-base">Save Title</button>
                <button id="cancelIterationEditBtn" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Program Creation Modal -->
    <div id="programModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Create New Program</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Program Name</label>
                    <input type="text" id="programName" placeholder="e.g., Summer Math Bootcamp" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Duration (Days)</label>
                    <select id="programDays" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="1">1 Day</option>
                        <option value="2">2 Days</option>
                        <option value="3">3 Days</option>
                        <option value="4">4 Days</option>
                        <option value="5">5 Days (Week)</option>
                        <option value="6">6 Days</option>
                        <option value="7">7 Days</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Start Time</label>
                    <select id="programStartTime" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="7">7:00 AM</option>
                        <option value="8" selected>8:00 AM</option>
                        <option value="9">9:00 AM</option>
                        <option value="10">10:00 AM</option>
                        <option value="11">11:00 AM</option>
                        <option value="12">12:00 PM</option>
                        <option value="13">1:00 PM</option>
                        <option value="14">2:00 PM</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">End Time</label>
                    <select id="programEndTime" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="12">12:00 PM</option>
                        <option value="13">1:00 PM</option>
                        <option value="14">2:00 PM</option>
                        <option value="15">3:00 PM</option>
                        <option value="16">4:00 PM</option>
                        <option value="17">5:00 PM</option>
                        <option value="18" selected>6:00 PM</option>
                        <option value="19">7:00 PM</option>
                        <option value="20">8:00 PM</option>
                        <option value="21">9:00 PM</option>
                        <option value="22">10:00 PM</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="saveProgramBtn" class="flex-1 bg-primary text-white px-4 py-2 rounded text-base">Create Program</button>
                <button id="cancelProgramBtn" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Session Edit Modal for Library -->
    <div id="sessionEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Edit Session</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Session Title</label>
                    <input type="text" id="editSessionTitle" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Instructor</label>
                    <input type="text" id="editSessionInstructor" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Duration</label>
                    <select id="editSessionDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="0.5">30 minutes</option>
                        <option value="1">1 hour</option>
                        <option value="1.5">1.5 hours (90 minutes)</option>
                        <option value="2">2 hours</option>
                        <option value="2.5">2.5 hours</option>
                        <option value="3">3 hours</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Session Type</label>
                    <select id="editSessionType" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="lecture">Lecture</option>
                        <option value="workshop">Workshop</option>
                        <option value="lab">Lab Session</option>
                        <option value="seminar">Seminar</option>
                        <option value="project">Project Work</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="saveEditSessionBtn" class="flex-1 bg-primary text-white px-4 py-2 rounded text-base">Save Changes</button>
                <button id="cancelEditSessionBtn" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Session Creation Modal -->
    <div id="sessionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Add Session to Program</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Session Title</label>
                        <input type="text" id="sessionTitle" placeholder="e.g., Introduction to Algebra" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Instructor</label>
                        <input type="text" id="sessionInstructor" placeholder="e.g., Dr. Smith" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Duration</label>
                        <select id="sessionDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                            <option value="0.5">30 minutes</option>
                            <option value="1">1 hour</option>
                            <option value="1.5" selected>1.5 hours (90 minutes)</option>
                            <option value="2">2 hours</option>
                            <option value="2.5">2.5 hours</option>
                            <option value="3">3 hours</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Session Type</label>
                        <select id="sessionType" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                            <option value="lecture">Lecture</option>
                            <option value="workshop">Workshop</option>
                            <option value="lab">Lab Session</option>
                            <option value="seminar">Seminar</option>
                            <option value="project">Project Work</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Materials</label>
                    <textarea id="sessionMaterials" placeholder="Required materials, handouts, equipment..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800 h-20 resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="sessionNotes" placeholder="Additional notes, preparation instructions..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800 h-20 resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Documents (up to 3)</label>
                    <input type="file" id="sessionDocuments" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.txt" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Upload up to 3 documents (PDF, Word, PowerPoint, Text)</p>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="saveSessionBtn" class="flex-1 bg-primary text-white px-4 py-2 rounded text-base">Add Session</button>
                <button id="cancelSessionBtn" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Session Details Modal -->
    <div id="sessionDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold" id="sessionDetailsTitle">Session Details</h3>
                <div class="flex space-x-2">
                    <button id="editSessionDetailsBtn" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                    <button id="closeSessionDetailsBtn" class="text-gray-600 hover:text-gray-800 text-sm">Close</button>
                </div>
            </div>
            
            <div id="sessionDetailsContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Session Details Edit Modal -->
    <div id="sessionDetailsEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-70">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold">Edit Session Details</h3>
                <button id="closeSessionDetailsEditBtn" class="text-gray-600 hover:text-gray-800 text-sm">Cancel</button>
            </div>
            
            <div class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Session Title</label>
                            <input type="text" id="detailsEditTitle" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Instructor</label>
                            <input type="text" id="detailsEditInstructor" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Duration</label>
                                <select id="detailsEditDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                                    <option value="0.5">30 minutes</option>
                                    <option value="1">1 hour</option>
                                    <option value="1.5">1.5 hours (90 minutes)</option>
                                    <option value="2">2 hours</option>
                                    <option value="2.5">2.5 hours</option>
                                    <option value="3">3 hours</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Session Type</label>
                                <select id="detailsEditType" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                                    <option value="lecture">Lecture</option>
                                    <option value="workshop">Workshop</option>
                                    <option value="lab">Lab Session</option>
                                    <option value="seminar">Seminar</option>
                                    <option value="project">Project Work</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Associated Programs</label>
                            <div id="detailsEditPrograms" class="space-y-2">
                                <!-- Program checkboxes will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Materials</label>
                            <textarea id="detailsEditMaterials" placeholder="Required materials, handouts, equipment..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800 h-24 resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Notes</label>
                            <textarea id="detailsEditNotes" placeholder="Additional notes, preparation instructions..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800 h-24 resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Documents</label>
                            <div id="detailsEditDocumentsList" class="mb-2">
                                <!-- Existing documents will be shown here -->
                            </div>
                            <input type="file" id="detailsEditDocuments" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.txt" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Upload up to 3 documents total (PDF, Word, PowerPoint, Text)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button id="saveSessionDetailsBtn" class="flex-1 bg-primary text-white px-4 py-2 rounded text-base">Save Changes</button>
                <button id="cancelSessionDetailsEditBtn" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Delete confirmation modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Remove Item</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Are you sure you want to remove this item from the schedule?</p>
            <div class="flex space-x-3">
                <button id="confirmDelete" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-base">Remove</button>
                <button id="cancelDelete" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Iteration Delete confirmation modal -->
    <div id="deleteIterationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Delete Iteration</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Are you sure you want to delete this iteration?</p>
            <div class="bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded p-4 mb-4">
                <div class="flex">
                    <svg class="w-5 h-5 text-yellow-400 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <div class="text-sm">
                        <p class="font-medium text-yellow-800 dark:text-yellow-200">Warning:</p>
                        <p class="text-yellow-700 dark:text-yellow-300">This will permanently delete the iteration "<span id="iterationNameToDelete" class="font-semibold"></span>" and all its scheduled content. This action cannot be undone.</p>
                    </div>
                </div>
            </div>
            <div class="flex space-x-3">
                <button id="confirmIterationDelete" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-base">Delete Iteration</button>
                <button id="cancelIterationDelete" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Operational Element Creation/Edit Modal -->
    <div id="operationalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 id="operationalModalTitle" class="text-lg font-semibold mb-4">Add Operational Element</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="operationalTitle" placeholder="e.g., Coffee Break" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Duration</label>
                    <select id="operationalDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="0.25">15 minutes</option>
                        <option value="0.5" selected>30 minutes</option>
                        <option value="1">1 hour</option>
                        <option value="1.5">1.5 hours (90 minutes)</option>
                        <option value="2">2 hours</option>
                        <option value="2.5">2.5 hours</option>
                        <option value="3">3 hours</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Type</label>
                    <select id="operationalType" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="meal">Meal</option>
                        <option value="break">Break</option>
                        <option value="logistics">Logistics</option>
                        <option value="networking">Networking</option>
                        <option value="ceremony">Ceremony</option>
                        <option value="transportation">Transportation</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Color</label>
                    <select id="operationalColor" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800">
                        <option value="bg-orange-300">Light Orange</option>
                        <option value="bg-orange-400">Orange</option>
                        <option value="bg-orange-500">Dark Orange</option>
                        <option value="bg-gray-500">Gray</option>
                        <option value="bg-gray-600">Dark Gray</option>
                        <option value="bg-gray-700">Darker Gray</option>
                        <option value="bg-red-500">Red</option>
                        <option value="bg-yellow-500">Yellow</option>
                        <option value="bg-green-500">Green</option>
                        <option value="bg-blue-500">Blue</option>
                        <option value="bg-purple-500">Purple</option>
                        <option value="bg-pink-500">Pink</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="saveOperationalBtn" class="flex-1 bg-primary text-white px-4 py-2 rounded text-base">Save Element</button>
                <button id="cancelOperationalBtn" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Operational Element Delete confirmation modal -->
    <div id="deleteOperationalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Delete Operational Element</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Are you sure you want to delete "<span id="operationalNameToDelete" class="font-semibold"></span>"? This will also remove it from all schedules.</p>
            <div class="flex space-x-3">
                <button id="confirmOperationalDelete" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-base">Delete Element</button>
                <button id="cancelOperationalDelete" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Program Details Modal -->
    <div id="programDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-semibold" id="programDetailsTitle">Program Details</h3>
                <div class="flex space-x-2">
                    <button id="editProgramDetailsBtn" class="text-blue-600 hover:text-blue-800 text-sm">Edit Details</button>
                    <button id="closeProgramDetailsBtn" class="text-gray-600 hover:text-gray-800 text-sm">Close</button>
                </div>
            </div>
            
            <div id="programDetailsContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Program Notes Edit Modal -->
    <div id="programNotesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold">Edit Program Notes</h3>
                <button id="closeProgramNotesBtn" class="text-gray-600 hover:text-gray-800 text-sm">Cancel</button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-1">Program Notes</label>
                    <textarea id="editProgramNotes" placeholder="General notes about the program, objectives, requirements..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800 h-32 resize-none"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Notable Changes</label>
                    <textarea id="editProgramNotableChanges" placeholder="Document significant changes made to the program over time..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded text-base bg-white dark:bg-gray-800 h-32 resize-none"></textarea>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button id="saveProgramNotesBtn" class="flex-1 bg-primary text-white px-4 py-2 rounded text-base">Save Notes</button>
                <button id="cancelProgramNotesBtn" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Subject area color mapping
        const subjectColors = {
            'mathematics': 'bg-blue-500',
            'science': 'bg-green-500',
            'engineering': 'bg-crimson-600',
            'humanities': 'bg-amber-500',
            'arts': 'bg-purple-500',
            'business': 'bg-indigo-500',
            'health': 'bg-emerald-500',
            'technology': 'bg-slate-600'
        };

        // Sample programs data
        const samplePrograms = {
            'math-bootcamp': {
                id: 'math-bootcamp',
                name: 'Summer Math Bootcamp',
                days: 5,
                startTime: 8,
                endTime: 18,
                startDate: new Date('2024-06-10'),
                sessions: [
                    { id: 'algebra-intro', title: 'Introduction to Algebra', instructor: 'Dr. Smith', duration: 1.5, type: 'lecture', subject: 'mathematics', color: 'bg-blue-500' },
                    { id: 'geometry-basics', title: 'Geometry Fundamentals', instructor: 'Prof. Johnson', duration: 1.5, type: 'workshop', subject: 'mathematics', color: 'bg-blue-500' },
                    { id: 'problem-solving', title: 'Problem Solving Techniques', instructor: 'Ms. Davis', duration: 1.5, type: 'seminar', subject: 'mathematics', color: 'bg-blue-500' },
                    { id: 'math-projects', title: 'Mathematical Projects', instructor: 'Dr. Wilson', duration: 1.5, type: 'project', subject: 'mathematics', color: 'bg-blue-500' },
                    { id: 'intensive-workshop', title: 'Advanced Mathematics Intensive Workshop', instructor: 'Dr. Anderson', duration: 3, type: 'workshop', subject: 'mathematics', color: 'bg-crimson-600' }
                ],
                templateOperational: {
                    '1-8': 'registration',
                    '1-12': 'lunch',
                    '2-12': 'lunch',
                    '3-12': 'lunch',
                    '4-12': 'lunch',
                    '5-12': 'lunch',
                    '5-17': 'closing'
                }
            },
            'science-intensive': {
                id: 'science-intensive',
                name: 'Science Research Intensive',
                days: 3,
                startTime: 8,
                endTime: 18,
                startDate: new Date('2024-07-15'),
                sessions: [
                    { id: 'physics-lab', title: 'Physics Laboratory', instructor: 'Dr. Brown', duration: 1.5, type: 'lab', subject: 'science', color: 'bg-green-500' },
                    { id: 'chemistry-exp', title: 'Chemistry Experiments', instructor: 'Prof. Lee', duration: 1.5, type: 'lab', subject: 'science', color: 'bg-green-500' },
                    { id: 'research-methods', title: 'Research Methodology', instructor: 'Dr. Taylor', duration: 1.5, type: 'lecture', subject: 'science', color: 'bg-green-500' },
                    { id: 'data-analysis', title: 'Data Analysis Workshop', instructor: 'Ms. Chen', duration: 1.5, type: 'workshop', subject: 'science', color: 'bg-green-500' }
                ],
                templateOperational: {
                    '1-8': 'registration',
                    '1-12': 'lunch',
                    '1-15': 'snack-break',
                    '2-12': 'lunch',
                    '2-15': 'snack-break',
                    '3-12': 'lunch',
                    '3-17': 'closing'
                }
            }
        };

        // Operational elements that apply to all programs
        const operationalElements = [
            { id: 'breakfast', title: 'Breakfast', duration: 1, color: 'bg-orange-400', type: 'meal' },
            { id: 'lunch', title: 'Lunch Break', duration: 1, color: 'bg-orange-500', type: 'meal' },
            { id: 'snack-break', title: 'Snack Break', duration: 0.5, color: 'bg-orange-300', type: 'break' },
            { id: 'registration', title: 'Registration & Check-in', duration: 1, color: 'bg-gray-500', type: 'logistics' },
            { id: 'orientation', title: 'Program Orientation', duration: 1, color: 'bg-gray-600', type: 'logistics' },
            { id: 'closing', title: 'Closing Ceremony', duration: 1, color: 'bg-gray-700', type: 'logistics' }
        ];

        let programs = { ...samplePrograms };
        let currentProgram = null;
        let currentIteration = 'current';
        let schedule = {};
        let itemToDelete = null;
        let currentView = 'schedule';
        let editingProgram = null;
        let editingIteration = null;

        // =========================
        // DATA PERSISTENCE FUNCTIONS
        // =========================

        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    programs: programs,
                    operationalElements: operationalElements,
                    currentProgram: currentProgram ? currentProgram.id : null,
                    currentIteration: currentIteration,
                    lastSaved: new Date().toISOString(),
                    version: '1.0'
                };
                
                localStorage.setItem('hlsee-schedule-data', JSON.stringify(dataToSave));
                console.log('Data saved to localStorage at', new Date().toLocaleTimeString());
                
                // Show visual feedback
                showSaveIndicator();
                
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showNotification('Error saving data: ' + error.message, 'error');
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('hlsee-schedule-data');
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Load programs
                    if (data.programs && Object.keys(data.programs).length > 0) {
                        programs = { ...data.programs };
                    }
                    
                    // Load operational elements
                    if (data.operationalElements && Array.isArray(data.operationalElements)) {
                        // Merge with defaults, avoiding duplicates
                        data.operationalElements.forEach(savedElement => {
                            const exists = operationalElements.find(e => e.id === savedElement.id);
                            if (!exists) {
                                operationalElements.push(savedElement);
                            } else {
                                // Update existing element
                                const index = operationalElements.findIndex(e => e.id === savedElement.id);
                                operationalElements[index] = savedElement;
                            }
                        });
                    }
                    
                    // Restore current program if it exists
                    if (data.currentProgram && programs[data.currentProgram]) {
                        setTimeout(() => {
                            document.getElementById('programSelect').value = data.currentProgram;
                            selectProgram(data.currentProgram);
                            
                            // Restore current iteration
                            if (data.currentIteration && currentProgram && currentProgram.iterations && currentProgram.iterations[data.currentIteration]) {
                                switchIteration(data.currentIteration);
                            }
                        }, 100);
                    }
                    
                    console.log('Data loaded from localStorage. Last saved:', data.lastSaved);
                    showNotification('Previous session restored!', 'success');
                    
                    return true;
                } else {
                    console.log('No saved data found in localStorage');
                    return false;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showNotification('Error loading saved data: ' + error.message, 'error');
                return false;
            }
        }

        function showSaveIndicator() {
            // Create or update save indicator
            let indicator = document.getElementById('saveIndicator');
            
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'saveIndicator';
                indicator.className = 'fixed top-4 left-4 z-50 px-3 py-1 rounded-full text-xs font-medium transition-all duration-300';
                document.body.appendChild(indicator);
            }
            
            // Show "Saved" state
            indicator.className = indicator.className.replace(/bg-\w+-\w+/g, '') + ' bg-green-600 text-white';
            indicator.textContent = '✓ Saved';
            indicator.style.opacity = '1';
            
            // Fade out after 1 second
            setTimeout(() => {
                indicator.style.opacity = '0.3';
                indicator.textContent = '💾 Auto-save enabled';
                indicator.className = indicator.className.replace('bg-green-600 text-white', 'bg-gray-600 text-white');
            }, 1000);
        }

        function clearLocalStorage() {
            if (confirm('⚠️ This will delete ALL your saved data and restore sample data. This cannot be undone!\n\nAre you sure you want to continue?')) {
                try {
                    localStorage.removeItem('hlsee-schedule-data');
                    
                    // Reset to sample data
                    programs = { ...samplePrograms };
                    currentProgram = null;
                    currentIteration = 'current';
                    schedule = {};
                    
                    // Reset operational elements to defaults
                    const defaultOperational = [
                        { id: 'breakfast', title: 'Breakfast', duration: 1, color: 'bg-orange-400', type: 'meal' },
                        { id: 'lunch', title: 'Lunch Break', duration: 1, color: 'bg-orange-500', type: 'meal' },
                        { id: 'snack-break', title: 'Snack Break', duration: 0.5, color: 'bg-orange-300', type: 'break' },
                        { id: 'registration', title: 'Registration & Check-in', duration: 1, color: 'bg-gray-500', type: 'logistics' },
                        { id: 'orientation', title: 'Program Orientation', duration: 1, color: 'bg-gray-600', type: 'logistics' },
                        { id: 'closing', title: 'Closing Ceremony', duration: 1, color: 'bg-gray-700', type: 'logistics' }
                    ];
                    
                    // Reset operational elements (remove any custom ones)
                    operationalElements.length = 0;
                    operationalElements.push(...defaultOperational);
                    
                    // Update all displays
                    renderProgramSelect();
                    hideProgramElements();
                    if (currentView === 'programs') {
                        renderProgramsManagement();
                    }
                    if (currentView === 'sessions') {
                        renderSessionLibrary();
                    }
                    renderOperationalElements();
                    
                    showNotification('All data cleared. Sample data restored.', 'success');
                } catch (error) {
                    showNotification('Error clearing data: ' + error.message, 'error');
                }
            }
        }

        // Auto-save wrapper function
        function autoSave() {
            // Debounce auto-save to avoid excessive saving
            if (window.autoSaveTimeout) {
                clearTimeout(window.autoSaveTimeout);
            }
            
            window.autoSaveTimeout = setTimeout(() => {
                saveToLocalStorage();
            }, 500); // Save 500ms after last change
        }

        // Add iterations to sample programs
        programs['math-bootcamp'].iterations = {
            'summer-2023': {
                title: 'Summer 2023',
                schedule: {
                    '1-8': 'registration', '1-8.25': 'registration', '1-8.5': 'registration', '1-8.75': 'registration',
                    '1-9': 'algebra-intro', '1-9.25': 'algebra-intro', '1-9.5': 'algebra-intro', '1-9.75': 'algebra-intro', '1-10': 'algebra-intro', '1-10.25': 'algebra-intro',
                    '1-12': 'lunch', '1-12.25': 'lunch', '1-12.5': 'lunch', '1-12.75': 'lunch',
                    '1-13': 'geometry-basics', '1-13.25': 'geometry-basics', '1-13.5': 'geometry-basics', '1-13.75': 'geometry-basics', '1-14': 'geometry-basics', '1-14.25': 'geometry-basics',
                    '2-9': 'problem-solving', '2-9.25': 'problem-solving', '2-9.5': 'problem-solving', '2-9.75': 'problem-solving', '2-10': 'problem-solving', '2-10.25': 'problem-solving',
                    '2-12': 'lunch', '2-12.25': 'lunch', '2-12.5': 'lunch', '2-12.75': 'lunch',
                    '2-14': 'intensive-workshop', '2-14.25': 'intensive-workshop', '2-14.5': 'intensive-workshop', '2-14.75': 'intensive-workshop', '2-15': 'intensive-workshop', '2-15.25': 'intensive-workshop', '2-15.5': 'intensive-workshop', '2-15.75': 'intensive-workshop', '2-16': 'intensive-workshop', '2-16.25': 'intensive-workshop', '2-16.5': 'intensive-workshop', '2-16.75': 'intensive-workshop',
                    '3-12': 'lunch', '3-12.25': 'lunch', '3-12.5': 'lunch', '3-12.75': 'lunch',
                    '4-12': 'lunch', '4-12.25': 'lunch', '4-12.5': 'lunch', '4-12.75': 'lunch',
                    '5-12': 'lunch', '5-12.25': 'lunch', '5-12.5': 'lunch', '5-12.75': 'lunch',
                    '5-17': 'closing', '5-17.25': 'closing', '5-17.5': 'closing', '5-17.75': 'closing'
                },
                isCompleted: true
            },
            'fall-2023': {
                title: 'Fall 2023',
                schedule: {
                    '1-8': 'registration', '1-8.25': 'registration', '1-8.5': 'registration', '1-8.75': 'registration',
                    '1-10': 'geometry-basics', '1-10.25': 'geometry-basics', '1-10.5': 'geometry-basics', '1-10.75': 'geometry-basics', '1-11': 'geometry-basics', '1-11.25': 'geometry-basics',
                    '1-12': 'lunch', '1-12.25': 'lunch', '1-12.5': 'lunch', '1-12.75': 'lunch',
                    '1-14': 'algebra-intro', '1-14.25': 'algebra-intro', '1-14.5': 'algebra-intro', '1-14.75': 'algebra-intro', '1-15': 'algebra-intro', '1-15.25': 'algebra-intro',
                    '2-12': 'lunch', '2-12.25': 'lunch', '2-12.5': 'lunch', '2-12.75': 'lunch',
                    '3-12': 'lunch', '3-12.25': 'lunch', '3-12.5': 'lunch', '3-12.75': 'lunch',
                    '4-12': 'lunch', '4-12.25': 'lunch', '4-12.5': 'lunch', '4-12.75': 'lunch',
                    '5-9': 'math-projects', '5-9.25': 'math-projects', '5-9.5': 'math-projects', '5-9.75': 'math-projects', '5-10': 'math-projects', '5-10.25': 'math-projects',
                    '5-12': 'lunch', '5-12.25': 'lunch', '5-12.5': 'lunch', '5-12.75': 'lunch',
                    '5-17': 'closing', '5-17.25': 'closing', '5-17.5': 'closing', '5-17.75': 'closing'
                },
                isCompleted: true
            },
            'current': {
                title: 'Summer 2024 (Current)',
                schedule: {},
                isCompleted: false
            }
        };

        programs['science-intensive'].iterations = {
            'spring-2023': {
                title: 'Spring 2023',
                schedule: {
                    '1-8': 'registration',
                    '1-9': 'physics-lab', '1-9.5': 'physics-lab', '1-10': 'physics-lab',
                    '1-12': 'lunch',
                    '1-15': 'snack-break',
                    '2-10': 'chemistry-exp', '2-10.5': 'chemistry-exp', '2-11': 'chemistry-exp',
                    '2-12': 'lunch',
                    '2-15': 'snack-break',
                    '3-12': 'lunch',
                    '3-17': 'closing'
                },
                isCompleted: true
            },
            'current': {
                title: 'Fall 2024 (Current)',
                schedule: {},
                isCompleted: false
            }
        };

        // Generate day names
        const dayNames = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];

        // Initialize the app
        function init() {
            // Load saved data first
            loadFromLocalStorage();
            
            renderProgramSelect();
            setupEventListeners();
        }

        function renderProgramSelect() {
            const programSelect = document.getElementById('programSelect');
            programSelect.innerHTML = '<option value="">Select a program...</option>' +
                Object.values(programs).map(program => 
                    `<option value="${program.id}">${program.name}</option>`
                ).join('');
        }

        function selectProgram(programId) {
            currentProgram = programs[programId];
            if (currentProgram) {
                schedule = {}; // Reset schedule when switching programs
                loadTemplateOperationalElements();
                renderProgramDetails();
                renderSessions();
                renderOperationalElements();
                renderCalendar();
                showProgramElements();
            } else {
                hideProgramElements();
            }
        }

        function loadTemplateOperationalElements() {
            if (currentProgram.templateOperational) {
                schedule = { ...currentProgram.templateOperational };
            }
        }

        function renderProgramDetails() {
            const programInfo = document.getElementById('programInfo');
            const templateCount = currentProgram.templateOperational ? Object.keys(currentProgram.templateOperational).length : 0;
            
            programInfo.innerHTML = `
                <div class="text-sm space-y-1">
                    <div><span class="font-medium">Duration:</span> ${currentProgram.days} day${currentProgram.days > 1 ? 's' : ''}</div>
                    <div><span class="font-medium">Hours:</span> ${formatTime(currentProgram.startTime)} - ${formatTime(currentProgram.endTime)}</div>
                    <div><span class="font-medium">Sessions:</span> ${currentProgram.sessions.length}</div>
                    <div><span class="font-medium">Template Items:</span> ${templateCount} operational element${templateCount !== 1 ? 's' : ''}</div>
                </div>
            `;
        }

        function renderSessions() {
            const sessionsList = document.getElementById('sessionsList');
            sessionsList.innerHTML = currentProgram.sessions.map(session => `
                <div class="session-item p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm transition-transform hover:scale-105" 
                     draggable="true" 
                     data-session-id="${session.id}"
                     data-item-type="session">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full ${session.color}"></div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-sm truncate">${session.title}</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${session.instructor}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${session.duration} hour${session.duration > 1 ? 's' : ''} • ${session.type}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderOperationalElements() {
            const operationalList = document.getElementById('operationalList');
            operationalList.innerHTML = operationalElements.map(element => `
                <div class="operational-item p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm transition-transform hover:scale-105" 
                     draggable="true" 
                     data-element-id="${element.id}"
                     data-item-type="operational">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full ${element.color}"></div>
                        <div class="flex-1 min-w-0 drag-handle">
                            <h3 class="font-medium text-sm truncate">${element.title}</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${element.duration} hour${element.duration != 1 ? 's' : ''} • ${element.type}</p>
                        </div>
                        <div class="flex space-x-1" onmousedown="event.stopPropagation();" onclick="event.stopPropagation();">
                            <button onclick="editOperationalElement('${element.id}')" class="text-blue-600 hover:text-blue-800 text-xs p-1 hover:bg-blue-50 dark:hover:bg-blue-900 rounded">
                                Edit
                            </button>
                            <button onclick="deleteOperationalElement('${element.id}')" class="text-red-600 hover:text-red-800 text-xs p-1 hover:bg-red-50 dark:hover:bg-red-900 rounded">
                                Del
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderCalendar() {
            const calendarTitle = document.getElementById('calendarTitle');
            calendarTitle.textContent = `${currentProgram.name} Schedule`;

            renderCalendarHeader();
            renderCalendarGrid();
        }

        function renderCalendarHeader() {
            const calendarGridHeader = document.getElementById('calendarGridHeader');
            const days = dayNames.slice(0, currentProgram.days);
            
            calendarGridHeader.innerHTML = `
                <div class="grid grid-cols-${currentProgram.days + 1} bg-gray-50 dark:bg-gray-700">
                    <div class="p-3 text-sm font-medium border-b border-r border-gray-200 dark:border-gray-600">Time</div>
                    ${days.map(day => `
                        <div class="p-3 text-sm font-medium border-b border-r border-gray-200 dark:border-gray-600 text-center">${day}</div>
                    `).join('')}
                </div>
            `;
        }

        function renderCalendarGrid() {
            const calendarGrid = document.getElementById('calendarGrid');
            const timeSlots = generateTimeSlots();
            
            calendarGrid.innerHTML = timeSlots.map(timeSlot => `
                <div class="grid grid-cols-${currentProgram.days + 1} border-b border-gray-200 dark:border-gray-600">
                    <div class="p-3 text-sm bg-gray-50 dark:bg-gray-700 border-r border-gray-200 dark:border-gray-600">${timeSlot.display}</div>
                    ${Array.from({length: currentProgram.days}, (_, dayIndex) => `
                        <div class="drop-zone min-h-[30px] p-1 border-r border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors relative" 
                             data-day="${dayIndex + 1}" 
                             data-hour="${timeSlot.hour}">
                            ${getScheduledItem(dayIndex + 1, timeSlot.hour)}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function generateTimeSlots() {
            const timeSlots = [];
            for (let hour = currentProgram.startTime; hour <= currentProgram.endTime; hour += 0.25) {
                const wholeHour = Math.floor(hour);
                const minutes = (hour % 1) * 60;
                const time12 = wholeHour > 12 ? 
                    `${wholeHour - 12}:${minutes.toString().padStart(2, '0')} PM` : 
                    wholeHour === 12 ? 
                        `12:${minutes.toString().padStart(2, '0')} PM` : 
                        `${wholeHour}:${minutes.toString().padStart(2, '0')} AM`;
                timeSlots.push({ hour, display: time12 });
            }
            return timeSlots;
        }

        function getScheduledItem(day, hour) {
            const itemId = schedule[`${day}-${hour}`];
            if (!itemId) return '';
            
            // Check if it's a session or operational element
            const session = currentProgram.sessions.find(s => s.id === itemId);
            const operational = operationalElements.find(o => o.id === itemId);
            const item = session || operational;
            
            if (!item) return '';

            // Debug logging
            console.log(`getScheduledItem: Day ${day}, Hour ${hour}, ItemId: ${itemId}, Item: ${item.title}`);

            // Check if this is the starting cell of the item
            const isStartingCell = isItemStartingHere(itemId, day, hour);
            console.log(`isStartingCell for ${item.title} at Day ${day}, Hour ${hour}: ${isStartingCell}`);
            
            if (!isStartingCell) {
                // This cell is part of a multi-hour item but not the starting cell
                return '<div class="occupied-cell invisible"></div>';
            }

            const isOperational = !!operational;
            const cssClass = isOperational ? 'scheduled-operational' : 'scheduled-session';
            
            // Calculate how many 15-minute slots this item spans
            const spanCount = Math.ceil(item.duration * 4); // Convert hours to 15-minute slots
            
            // Use CSS calc to span exactly the right number of grid rows
            const heightCalc = `calc(${spanCount} * (100% + 1px) - 4px)`; // Account for borders between rows
            
            console.log(`Rendering visual block for ${item.title} at Day ${day}, Hour ${hour}, spanning ${spanCount} slots (${item.duration}h)`);

            return `
                <div class="${cssClass} ${item.color} text-white p-2 rounded text-xs font-medium transition-transform spanning-item"
                     data-item-id="${itemId}"
                     data-day="${day}"
                     data-hour="${hour}"
                     data-item-type="${isOperational ? 'operational' : 'session'}"
                     draggable="true"
                     style="position: absolute; width: calc(100% - 8px); z-index: 10; margin: 2px; cursor: grab; height: ${heightCalc}; top: 0;">
                    <div class="font-semibold text-xs leading-tight">${item.title}</div>
                    ${session ? `<div class="opacity-90 text-xs leading-tight">${session.instructor}</div>` : ''}
                    <div class="text-xs opacity-75 mt-1">${item.duration}h</div>
                </div>
            `;
        }

        function isItemStartingHere(itemId, day, hour) {
            // Check if this is the first occurrence of this item in this day
            const timeSlots = generateTimeSlots();
            const currentSlotIndex = timeSlots.findIndex(slot => slot.hour === hour);
            
            // Check the previous slot in the same day
            if (currentSlotIndex > 0) {
                const prevSlot = timeSlots[currentSlotIndex - 1];
                const prevItemId = schedule[`${day}-${prevSlot.hour}`];
                if (prevItemId === itemId) {
                    return false; // This item started in a previous slot in the same day
                }
            }
            
            return true; // This is the starting slot for this item in this day
        }

        function scheduleItem(itemId, itemType, day, hour) {
            let item;
            if (itemType === 'session') {
                item = currentProgram.sessions.find(s => s.id === itemId);
            } else {
                item = operationalElements.find(o => o.id === itemId);
            }
            
            if (!item) return;

            console.log(`Scheduling ${item.title} (${item.duration}h) in Day ${day} at hour ${hour}`);

            // Check if slot is already occupied
            const key = `${day}-${hour}`;
            if (schedule[key]) {
                alert('This time slot is already occupied!');
                return;
            }

            // Check if there's enough consecutive time slots vertically for the item duration
            const timeSlots = generateTimeSlots();
            const startSlotIndex = timeSlots.findIndex(slot => slot.hour === hour);
            const slotsNeeded = Math.ceil(item.duration * 4); // Convert hours to 15-minute slots
            
            console.log(`Need ${slotsNeeded} slots, starting at index ${startSlotIndex}`);
            
            for (let i = 0; i < slotsNeeded; i++) {
                const slotIndex = startSlotIndex + i;
                if (slotIndex >= timeSlots.length) {
                    alert(`Not enough consecutive time available for this ${item.duration}-hour item!`);
                    return;
                }
                
                const timeSlot = timeSlots[slotIndex];
                const checkKey = `${day}-${timeSlot.hour}`;
                if (schedule[checkKey]) {
                    alert('This time slot is already occupied!');
                    return;
                }
            }

            // Schedule the item ONLY in the specified day, spanning vertically down time slots
            const scheduledKeys = [];
            for (let i = 0; i < slotsNeeded; i++) {
                const slotIndex = startSlotIndex + i;
                const timeSlot = timeSlots[slotIndex];
                const scheduleKey = `${day}-${timeSlot.hour}`;
                schedule[scheduleKey] = itemId;
                scheduledKeys.push(scheduleKey);
            }
            
            console.log('Scheduled keys:', scheduledKeys);
            console.log('Current schedule state:', schedule);

            renderCalendarGrid();
        }

        function moveScheduledItem(itemId, itemType, currentDay, currentHour, newDay, newHour) {
            let item;
            if (itemType === 'session') {
                item = currentProgram.sessions.find(s => s.id === itemId);
            } else {
                item = operationalElements.find(o => o.id === itemId);
            }
            
            if (!item) return;

            console.log(`Moving ${item.title} from Day ${currentDay} at ${currentHour} to Day ${newDay} at ${newHour}`);

            // Check if trying to move to the same position
            if (currentDay === newDay && currentHour === newHour) {
                console.log('Item is already in this position');
                return;
            }

            // First, remove the item from its current position
            const keysToRemove = [];
            Object.keys(schedule).forEach(key => {
                if (schedule[key] === itemId) {
                    keysToRemove.push(key);
                }
            });
            
            console.log('Removing keys:', keysToRemove);
            keysToRemove.forEach(key => {
                delete schedule[key];
            });

            // Check if new position has enough space and is not occupied
            const timeSlots = generateTimeSlots();
            const startSlotIndex = timeSlots.findIndex(slot => slot.hour === newHour);
            const slotsNeeded = Math.ceil(item.duration * 4); // Convert hours to 15-minute slots
            
            // Check for conflicts
            for (let i = 0; i < slotsNeeded; i++) {
                const slotIndex = startSlotIndex + i;
                if (slotIndex >= timeSlots.length) {
                    // Not enough space - restore original position
                    console.log('Not enough space at new position, restoring original');
                    keysToRemove.forEach(key => {
                        schedule[key] = itemId;
                    });
                    alert(`Not enough consecutive time available for this ${item.duration}-hour item!`);
                    renderCalendarGrid();
                    return;
                }
                
                const timeSlot = timeSlots[slotIndex];
                const checkKey = `${newDay}-${timeSlot.hour}`;
                if (schedule[checkKey]) {
                    // Conflict - restore original position
                    console.log('Conflict detected, restoring original position');
                    keysToRemove.forEach(key => {
                        schedule[key] = itemId;
                    });
                    alert('This time slot is already occupied!');
                    renderCalendarGrid();
                    return;
                }
            }

            // Schedule the item in the new position
            const scheduledKeys = [];
            for (let i = 0; i < slotsNeeded; i++) {
                const slotIndex = startSlotIndex + i;
                const timeSlot = timeSlots[slotIndex];
                const scheduleKey = `${newDay}-${timeSlot.hour}`;
                schedule[scheduleKey] = itemId;
                scheduledKeys.push(scheduleKey);
            }
            
            console.log('Item moved. New keys:', scheduledKeys);

            renderCalendarGrid();
            autoSave();
        }

        function showProgramElements() {
            document.getElementById('noProgram').classList.add('hidden');
            document.getElementById('calendarHeader').classList.remove('hidden');
            document.getElementById('calendarContainer').classList.remove('hidden');
            document.getElementById('programDetails').classList.remove('hidden');
            document.getElementById('sessionsSection').classList.remove('hidden');
            document.getElementById('operationalSection').classList.remove('hidden');
            renderIterationDropdown();
        }

        function hideProgramElements() {
            document.getElementById('noProgram').classList.remove('hidden');
            document.getElementById('calendarHeader').classList.add('hidden');
            document.getElementById('calendarContainer').classList.add('hidden');
            document.getElementById('programDetails').classList.add('hidden');
            document.getElementById('sessionsSection').classList.add('hidden');
            document.getElementById('operationalSection').classList.add('hidden');
        }

        function formatTime(hour) {
            return hour > 12 ? `${hour - 12}:00 PM` : hour === 12 ? '12:00 PM' : `${hour}:00 AM`;
        }

        function getRandomColor() {
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-crimson-600', 'bg-red-500', 'bg-yellow-500', 'bg-indigo-500', 'bg-pink-500', 'bg-teal-500'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        function getActualDayName(dayIndex) {
            if (currentProgram && currentProgram.startDate) {
                const date = new Date(currentProgram.startDate);
                date.setDate(date.getDate() + dayIndex);
                return formatDate(date);
            }
            return dayNames[dayIndex];
        }

        function setupEventListeners() {
            // Program selection
            document.getElementById('programSelect').addEventListener('change', (e) => {
                selectProgram(e.target.value);
            });

            // Drag and drop
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('session-item') || e.target.classList.contains('operational-item')) {
                    // Dragging from sidebar
                    const itemId = e.target.dataset.sessionId || e.target.dataset.elementId;
                    const itemType = e.target.dataset.itemType;
                    e.dataTransfer.setData('text/plain', JSON.stringify({ itemId, itemType, action: 'add' }));
                    e.target.style.opacity = '0.5';
                } else if (e.target.classList.contains('scheduled-session') || e.target.classList.contains('scheduled-operational')) {
                    // Dragging scheduled blocks to move them
                    const itemId = e.target.dataset.itemId;
                    const itemType = e.target.dataset.itemType;
                    const currentDay = e.target.dataset.day;
                    const currentHour = e.target.dataset.hour;
                    e.dataTransfer.setData('text/plain', JSON.stringify({ 
                        itemId, 
                        itemType, 
                        action: 'move',
                        currentDay: parseInt(currentDay),
                        currentHour: parseFloat(currentHour)
                    }));
                    e.target.style.opacity = '0.5';
                    e.target.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('session-item') || e.target.classList.contains('operational-item')) {
                    e.target.style.opacity = '1';
                } else if (e.target.classList.contains('scheduled-session') || e.target.classList.contains('scheduled-operational')) {
                    e.target.style.opacity = '1';
                    e.target.style.cursor = 'grab';
                }
            });

            document.addEventListener('dragover', (e) => {
                if (e.target.classList.contains('drop-zone') || e.target.closest('.drop-zone')) {
                    e.preventDefault();
                    const dropZone = e.target.classList.contains('drop-zone') ? e.target : e.target.closest('.drop-zone');
                    dropZone.classList.add('drag-over');
                }
            });

            document.addEventListener('dragleave', (e) => {
                if (e.target.classList.contains('drop-zone')) {
                    e.target.classList.remove('drag-over');
                }
            });

            document.addEventListener('drop', (e) => {
                e.preventDefault();
                const dropZone = e.target.classList.contains('drop-zone') ? e.target : e.target.closest('.drop-zone');
                if (dropZone) {
                    dropZone.classList.remove('drag-over');
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const day = parseInt(dropZone.dataset.day);
                    const hour = parseFloat(dropZone.dataset.hour);
                    
                    if (data.action === 'move') {
                        moveScheduledItem(data.itemId, data.itemType, data.currentDay, data.currentHour, day, hour);
                    } else {
                        scheduleItem(data.itemId, data.itemType, day, hour);
                    }
                }
            });

            // Click to remove scheduled items
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('scheduled-session') || e.target.classList.contains('scheduled-operational') || e.target.closest('.scheduled-session') || e.target.closest('.scheduled-operational')) {
                    const itemElement = e.target.classList.contains('scheduled-session') || e.target.classList.contains('scheduled-operational') ? e.target : e.target.closest('.scheduled-session') || e.target.closest('.scheduled-operational');
                    itemToDelete = {
                        day: itemElement.dataset.day,
                        hour: itemElement.dataset.hour
                    };
                    document.getElementById('deleteModal').classList.remove('hidden');
                }
            });

            // Program creation modal
            document.getElementById('newProgramBtn').addEventListener('click', () => {
                document.getElementById('programModal').classList.remove('hidden');
            });

            document.getElementById('cancelProgramBtn').addEventListener('click', () => {
                document.getElementById('programModal').classList.add('hidden');
                clearProgramForm();
            });

            document.getElementById('saveProgramBtn').addEventListener('click', () => {
                const name = document.getElementById('programName').value.trim();
                const days = parseInt(document.getElementById('programDays').value);
                const startTime = parseInt(document.getElementById('programStartTime').value);
                const endTime = parseInt(document.getElementById('programEndTime').value);
                
                if (name && days && startTime < endTime) {
                    const newProgram = {
                        id: `program-${Date.now()}`,
                        name,
                        days,
                        startTime,
                        endTime,
                        sessions: []
                    };
                    programs[newProgram.id] = newProgram;
                    renderProgramSelect();
                    document.getElementById('programSelect').value = newProgram.id;
                    selectProgram(newProgram.id);
                    document.getElementById('programModal').classList.add('hidden');
                    clearProgramForm();
                    autoSave();
                }
            });

            // Session creation modal
            document.getElementById('addSessionBtn').addEventListener('click', () => {
                document.getElementById('sessionModal').classList.remove('hidden');
            });

            document.getElementById('cancelSessionBtn').addEventListener('click', () => {
                document.getElementById('sessionModal').classList.add('hidden');
                clearSessionForm();
            });

            document.getElementById('saveSessionBtn').addEventListener('click', () => {
                const title = document.getElementById('sessionTitle').value.trim();
                const instructor = document.getElementById('sessionInstructor').value.trim();
                const duration = parseFloat(document.getElementById('sessionDuration').value);
                const type = document.getElementById('sessionType').value;
                const materials = document.getElementById('sessionMaterials').value.trim();
                const notes = document.getElementById('sessionNotes').value.trim();
                
                if (title && instructor && currentProgram) {
                    const newSession = {
                        id: `session-${Date.now()}`,
                        title,
                        instructor,
                        duration,
                        type,
                        materials: materials || null,
                        notes: notes || null,
                        documents: [],
                        color: getRandomColor()
                    };
                    
                    // Handle file uploads (simulated)
                    const fileInput = document.getElementById('sessionDocuments');
                    if (fileInput.files.length > 0) {
                        Array.from(fileInput.files).slice(0, 3).forEach(file => {
                            newSession.documents.push({
                                id: `doc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                uploadDate: new Date().toISOString()
                            });
                        });
                    }
                    
                    currentProgram.sessions.push(newSession);
                    renderSessions();
                    renderProgramDetails();
                    document.getElementById('sessionModal').classList.add('hidden');
                    clearSessionForm();
                    autoSave();
                }
            });

            // Delete modal
            document.getElementById('confirmDelete').addEventListener('click', () => {
                if (itemToDelete) {
                    const itemId = schedule[`${itemToDelete.day}-${itemToDelete.hour}`];
                    
                    // Find and remove ALL instances of this item from the schedule
                    const keysToDelete = [];
                    Object.keys(schedule).forEach(key => {
                        if (schedule[key] === itemId) {
                            keysToDelete.push(key);
                        }
                    });
                    
                    // Delete all instances
                    keysToDelete.forEach(key => {
                        delete schedule[key];
                    });
                    
                    renderCalendarGrid();
                }
                document.getElementById('deleteModal').classList.add('hidden');
                itemToDelete = null;
            });

            document.getElementById('cancelDelete').addEventListener('click', () => {
                document.getElementById('deleteModal').classList.add('hidden');
                itemToDelete = null;
            });

            // Save template operational elements
            document.getElementById('saveTemplateBtn').addEventListener('click', () => {
                saveOperationalTemplate();
            });

            // Export PDF
            document.getElementById('exportPdfBtn').addEventListener('click', () => {
                exportToPDF();
            });

            // Clear Schedule
            document.getElementById('clearScheduleBtn').addEventListener('click', () => {
                if (confirm('Clear all sessions and keep only operational template items?')) {
                    clearSchedule();
                }
            });

            // Debug Schedule
            document.getElementById('debugScheduleBtn').addEventListener('click', () => {
                debugSchedule();
            });
        }

        function exportToPDF() {
            if (!currentProgram) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'pt', 'a4');
            
            // Page dimensions
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 30;
            
            // Title
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(currentProgram.name, margin, margin + 15);
            
            // Program details
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const detailsY = margin + 35;
            doc.text(`Duration: ${currentProgram.days} day${currentProgram.days > 1 ? 's' : ''} | Time: ${formatTime(currentProgram.startTime)} - ${formatTime(currentProgram.endTime)} | Sessions: ${currentProgram.sessions.length}`, margin, detailsY);
            
            // Generate 15-minute time slots for PDF
            const generatePDFTimeSlots = () => {
                const slots = [];
                for (let hour = currentProgram.startTime; hour <= currentProgram.endTime; hour += 0.25) {
                    const wholeHour = Math.floor(hour);
                    const minutes = (hour % 1) * 60;
                    const time12 = wholeHour > 12 ? 
                        `${wholeHour - 12}:${minutes.toString().padStart(2, '0')} PM` : 
                        wholeHour === 12 ? 
                            `12:${minutes.toString().padStart(2, '0')} PM` : 
                            `${wholeHour}:${minutes.toString().padStart(2, '0')} AM`;
                    slots.push({ hour, display: time12 });
                }
                return slots;
            };

            const timeSlots = generatePDFTimeSlots();
            const dayHeaders = dayNames.slice(0, currentProgram.days);
            
            // Create table headers
            const headers = [['Time', ...dayHeaders]];
            
            // Process schedule to find items that start in each time slot
            const processScheduleForPDF = () => {
                const processedSchedule = {};
                const processedItems = new Set();
                
                timeSlots.forEach(timeSlot => {
                    for (let day = 1; day <= currentProgram.days; day++) {
                        const hourKey = `${day}-${timeSlot.hour}`;
                        const itemId = schedule[hourKey];
                        
                        if (itemId && !processedItems.has(`${itemId}-${day}-${timeSlot.hour}`)) {
                            // Check if this is the starting point of the item by looking at previous slot
                            const isStartingSlot = isItemStartingHere(itemId, day, timeSlot.hour);
                            
                            if (isStartingSlot) {
                                const session = currentProgram.sessions.find(s => s.id === itemId);
                                const operational = operationalElements.find(o => o.id === itemId);
                                const item = session || operational;
                                
                                if (item) {
                                    // Calculate start and end times for this item
                                    const startTime = timeSlot.hour;
                                    const endTime = startTime + item.duration;
                                    
                                    // Format time display
                                    const formatTimeForDisplay = (hour) => {
                                        const wholeHour = Math.floor(hour);
                                        const minutes = (hour % 1) * 60;
                                        return wholeHour > 12 ? 
                                            `${wholeHour - 12}:${minutes.toString().padStart(2, '0')}` : 
                                            wholeHour === 12 ? 
                                                `12:${minutes.toString().padStart(2, '0')}` : 
                                                `${wholeHour}:${minutes.toString().padStart(2, '0')}`;
                                    };
                                    
                                    const timeSpan = `${formatTimeForDisplay(startTime)}-${formatTimeForDisplay(endTime)}`;
                                    
                                    processedSchedule[hourKey] = {
                                        id: itemId,
                                        title: item.title,
                                        instructor: session ? session.instructor : null,
                                        duration: item.duration,
                                        timeSpan: timeSpan,
                                        color: item.color,
                                        type: session ? 'session' : 'operational'
                                    };
                                    processedItems.add(`${itemId}-${day}-${timeSlot.hour}`);
                                }
                            }
                        }
                    }
                });
                
                return processedSchedule;
            };

            const processedSchedule = processScheduleForPDF();
            
            // Create table data with merged cells
            const tableData = [];
            const mergedCells = new Map(); // Track which cells are part of merged ranges
            
            timeSlots.forEach((timeSlot, rowIndex) => {
                const row = [timeSlot.display];
                
                for (let day = 1; day <= currentProgram.days; day++) {
                    const hourKey = `${day}-${timeSlot.hour}`;
                    const cellKey = `${rowIndex}-${day}`;
                    
                    // Check if this cell is already part of a merged range
                    if (mergedCells.has(cellKey)) {
                        row.push(''); // Empty cell for merged ranges
                        continue;
                    }
                    
                    const item = processedSchedule[hourKey];
                    
                    if (item) {
                        // Calculate how many rows this item should span
                        const slotsNeeded = Math.ceil(item.duration * 4); // Convert hours to 15-minute slots
                        
                        // Mark all cells in this merged range
                        for (let i = 0; i < slotsNeeded; i++) {
                            const mergedCellKey = `${rowIndex + i}-${day}`;
                            mergedCells.set(mergedCellKey, {
                                rowSpan: i === 0 ? slotsNeeded : 0,
                                content: i === 0 ? `${item.title}\n${item.instructor || ''}\n${item.timeSpan}` : ''
                            });
                        }
                        
                        // Add content only to the first cell
                        let cellText = item.title;
                        if (item.instructor) {
                            cellText += `\n${item.instructor}`;
                        }
                        cellText += `\n${item.timeSpan}`;
                        row.push(cellText);
                    } else {
                        row.push('');
                    }
                }
                
                tableData.push(row);
            });

            // Color mapping function
            function getColorForItem(itemId) {
                const session = currentProgram.sessions.find(s => s.id === itemId);
                const operational = operationalElements.find(o => o.id === itemId);
                
                if (session) {
                    const colorMap = {
                        'bg-blue-500': [59, 130, 246],
                        'bg-green-500': [34, 197, 94],
                        'bg-purple-500': [168, 85, 247],
                        'bg-red-500': [239, 68, 68],
                        'bg-yellow-500': [234, 179, 8],
                        'bg-indigo-500': [99, 102, 241],
                        'bg-pink-500': [236, 72, 153],
                        'bg-teal-500': [20, 184, 166],
                        'bg-crimson-600': [220, 20, 60]
                    };
                    return colorMap[session.color] || [100, 100, 100];
                } else if (operational) {
                    const colorMap = {
                        'bg-orange-400': [251, 146, 60],
                        'bg-orange-500': [249, 115, 22],
                        'bg-orange-300': [253, 186, 116],
                        'bg-gray-500': [107, 114, 128],
                        'bg-gray-600': [75, 85, 99],
                        'bg-gray-700': [55, 65, 81]
                    };
                    return colorMap[operational.color] || [100, 100, 100];
                }
                return [255, 255, 255];
            }

            // Calculate available space for table and equal column widths
            const availableHeight = pageHeight - detailsY - 150; // Leave space for legend and footer
            const availableWidth = pageWidth - (margin * 2);
            const timeColumnWidth = 60; // Fixed width for time column
            const remainingWidth = availableWidth - timeColumnWidth;
            const dayColumnWidth = remainingWidth / currentProgram.days; // Equal width for all day columns
            
            // Create column styles with equal widths
            const columnStyles = {
                0: { 
                    cellWidth: timeColumnWidth, 
                    halign: 'center', 
                    fontStyle: 'bold',
                    fontSize: 6
                }
            };
            
            // Set equal width for all day columns
            for (let i = 1; i <= currentProgram.days; i++) {
                columnStyles[i] = {
                    cellWidth: dayColumnWidth,
                    halign: 'center',
                    fontSize: 6
                };
            }

            // Create the schedule table with proper row spanning
            doc.autoTable({
                head: headers,
                body: tableData,
                startY: detailsY + 20,
                styles: {
                    fontSize: 5,           // Much smaller font
                    cellPadding: 1,        // Minimal padding
                    lineColor: [200, 200, 200],
                    lineWidth: 0.2,        // Thinner lines
                    halign: 'center',
                    valign: 'middle',
                    minCellHeight: 8       // Smaller row height
                },
                headStyles: {
                    fillColor: [165, 28, 48],  // Harvard crimson background
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 7,
                    cellPadding: 2,
                    font: 'serif'  // Harvard-style serif font for headers
                },
                columnStyles: columnStyles,    // Use our calculated equal-width columns
                tableWidth: availableWidth,   // Use full available width
                margin: { left: margin, right: margin },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index > 0) {
                        const rowIndex = data.row.index;
                        const dayIndex = data.column.index;
                        const cellKey = `${rowIndex}-${dayIndex}`;
                        const timeSlot = timeSlots[rowIndex];
                        const hourKey = `${dayIndex}-${timeSlot.hour}`;
                        const item = processedSchedule[hourKey];
                        
                        // Check if this cell is part of a merged range
                        if (mergedCells.has(cellKey)) {
                            const mergedData = mergedCells.get(cellKey);
                            if (mergedData.rowSpan > 1) {
                                // Apply row span for the starting cell
                                data.cell.rowSpan = mergedData.rowSpan;
                            } else if (mergedData.rowSpan === 0) {
                                // This cell is part of a merged range but not the starting cell
                                // jsPDF autoTable will handle this automatically
                            }
                        }
                        
                        if (item) {
                            const [r, g, b] = getColorForItem(item.id);
                            data.cell.styles.fillColor = [r, g, b];
                            data.cell.styles.textColor = [255, 255, 255];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                }
            });

            // Add compact legend at the bottom
            const legendY = Math.max(doc.lastAutoTable.finalY + 15, pageHeight - 120);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('Legend:', margin, legendY);
            
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            let legendX = margin + 45;
            let legendCurrentY = legendY;
            const legendItemWidth = 140;
            let itemsPerRow = Math.floor((pageWidth - margin * 2 - 45) / legendItemWidth);
            let currentItem = 0;
            
            // Sessions legend
            if (currentProgram.sessions.length > 0) {
                currentProgram.sessions.forEach(session => {
                    if (currentItem % itemsPerRow === 0 && currentItem > 0) {
                        legendCurrentY += 12;
                        legendX = margin + 45;
                    }
                    
                    const [r, g, b] = getColorForItem(session.id);
                    doc.setFillColor(r, g, b);
                    doc.rect(legendX, legendCurrentY - 6, 8, 8, 'F');
                    doc.text(`${session.title}`, legendX + 12, legendCurrentY);
                    
                    legendX += legendItemWidth;
                    currentItem++;
                });
            }
            
            // Operational elements legend
            const usedOperational = [...new Set(Object.values(schedule))].filter(itemId => 
                operationalElements.find(o => o.id === itemId)
            );
            
            if (usedOperational.length > 0) {
                usedOperational.forEach(itemId => {
                    const operational = operationalElements.find(o => o.id === itemId);
                    if (operational) {
                        if (currentItem % itemsPerRow === 0 && currentItem > 0) {
                            legendCurrentY += 12;
                            legendX = margin + 45;
                        }
                        
                        const [r, g, b] = getColorForItem(itemId);
                        doc.setFillColor(r, g, b);
                        doc.rect(legendX, legendCurrentY - 6, 8, 8, 'F');
                        doc.text(`${operational.title}`, legendX + 12, legendCurrentY);
                        
                        legendX += legendItemWidth;
                        currentItem++;
                    }
                });
            }
            
            // Add footer
            doc.setFontSize(6);
            doc.setTextColor(100, 100, 100);
            const currentIterationTitle = currentProgram.iterations && currentProgram.iterations[currentIteration] ? 
                currentProgram.iterations[currentIteration].title : 'Current';
            doc.text(`Generated: ${new Date().toLocaleDateString()} | Iteration: ${currentIterationTitle}`, 
                margin, pageHeight - 15);
            
            // Save the PDF
            const fileName = `${currentProgram.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_schedule.pdf`;
            doc.save(fileName);
            
            // Show success feedback
            const exportBtn = document.getElementById('exportPdfBtn');
            const originalHTML = exportBtn.innerHTML;
            exportBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Exported!</span>
            `;
            exportBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            exportBtn.classList.add('bg-green-600');
            
            setTimeout(() => {
                exportBtn.innerHTML = originalHTML;
                exportBtn.classList.remove('bg-green-600');
                exportBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            }, 3000);
        }

        function saveOperationalTemplate() {
            if (!currentProgram) return;
            
            // Extract only operational elements from current schedule
            const operationalSchedule = {};
            Object.keys(schedule).forEach(key => {
                const itemId = schedule[key];
                const isOperational = operationalElements.find(o => o.id === itemId);
                if (isOperational) {
                    operationalSchedule[key] = itemId;
                }
            });
            
            // Save to program template
            currentProgram.templateOperational = operationalSchedule;
            programs[currentProgram.id] = currentProgram;
            
            // Show success feedback
            const saveBtn = document.getElementById('saveTemplateBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saved!';
            saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            saveBtn.classList.add('bg-green-600');
            
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.classList.remove('bg-green-600');
                saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 2000);
        }

        function clearProgramForm() {
            document.getElementById('programName').value = '';
            document.getElementById('programDays').value = '5';
            document.getElementById('programStartTime').value = '9';
            document.getElementById('programEndTime').value = '18';
        }

        function clearSessionForm() {
            document.getElementById('sessionTitle').value = '';
            document.getElementById('sessionInstructor').value = '';
            document.getElementById('sessionDuration').value = '1.5';
            document.getElementById('sessionType').value = 'lecture';
            document.getElementById('sessionMaterials').value = '';
            document.getElementById('sessionNotes').value = '';
            document.getElementById('sessionDocuments').value = '';
        }

        // Navigation and view management
        function switchView(view) {
            currentView = view;
            
            // Update tab styles
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-primary', 'text-white');
                tab.classList.add('text-gray-600', 'dark:text-gray-400');
            });
            
            // Hide all views
            document.getElementById('scheduleView').classList.add('hidden');
            document.getElementById('programsView').classList.add('hidden');
            document.getElementById('sessionsView').classList.add('hidden');
            document.getElementById('iterationTabs').classList.add('hidden');
            
            // Show selected view
            if (view === 'schedule') {
                document.getElementById('scheduleView').classList.remove('hidden');
                document.getElementById('scheduleTab').classList.add('active', 'bg-primary', 'text-white');
                document.getElementById('scheduleTab').classList.remove('text-gray-600', 'dark:text-gray-400');
                if (currentProgram) {
                    document.getElementById('iterationTabs').classList.remove('hidden');
                    renderIterationTabs();
                }
            } else if (view === 'programs') {
                document.getElementById('programsView').classList.remove('hidden');
                document.getElementById('programsTab').classList.add('active', 'bg-primary', 'text-white');
                document.getElementById('programsTab').classList.remove('text-gray-600', 'dark:text-gray-400');
                renderProgramsManagement();
            } else if (view === 'sessions') {
                document.getElementById('sessionsView').classList.remove('hidden');
                document.getElementById('sessionsTab').classList.add('active', 'bg-primary', 'text-white');
                document.getElementById('sessionsTab').classList.remove('text-gray-600', 'dark:text-gray-400');
                renderSessionLibrary();
            }
        }

        // Program management functions
        function renderProgramsManagement() {
            const programsList = document.getElementById('programsList');
            programsList.innerHTML = Object.values(programs).map(program => {
                const iterationCount = Object.keys(program.iterations || {}).length;
                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">${program.name}</h3>
                            <div class="flex space-x-2">
                                <button onclick="viewProgramDetails('${program.id}')" class="text-primary hover:text-primaryDark text-sm">
                                    View Details
                                </button>
                                <button onclick="editProgram('${program.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    Edit
                                </button>
                                <button onclick="deleteProgram('${program.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-600 dark:text-gray-400">Duration:</span>
                                <div>${program.days} day${program.days > 1 ? 's' : ''}</div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600 dark:text-gray-400">Hours:</span>
                                <div>${formatTime(program.startTime)} - ${formatTime(program.endTime)}</div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600 dark:text-gray-400">Sessions:</span>
                                <div>${program.sessions.length}</div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600 dark:text-gray-400">Iterations:</span>
                                <div>${iterationCount}</div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 flex space-x-2">
                            <button onclick="switchToProgram('${program.id}')" class="bg-primary hover:bg-primaryDark text-white px-4 py-2 rounded text-sm">
                                Open in Schedule Builder
                            </button>
                            <button onclick="editProgramNotes('${program.id}')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
                                Edit Notes
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editProgram(programId) {
            editingProgram = programId;
            const program = programs[programId];
            
            document.getElementById('editProgramName').value = program.name;
            document.getElementById('editProgramDays').value = program.days;
            document.getElementById('editProgramStartTime').value = program.startTime;
            document.getElementById('editProgramEndTime').value = program.endTime;
            
            document.getElementById('programEditModal').classList.remove('hidden');
        }

        function deleteProgram(programId) {
            if (confirm('Are you sure you want to delete this program? This action cannot be undone.')) {
                delete programs[programId];
                renderProgramsManagement();
                renderProgramSelect();
                if (currentProgram && currentProgram.id === programId) {
                    currentProgram = null;
                    hideProgramElements();
                }
            }
        }

        function switchToProgram(programId) {
            switchView('schedule');
            document.getElementById('programSelect').value = programId;
            selectProgram(programId);
        }

        function openIterationInScheduleBuilder(programId, iterationId) {
            // Close the program details modal
            document.getElementById('programDetailsModal').classList.add('hidden');
            currentProgramDetails = null;
            
            // Switch to schedule view
            switchView('schedule');
            
            // Select the program
            document.getElementById('programSelect').value = programId;
            selectProgram(programId);
            
            // Switch to the specific iteration
            if (currentProgram && currentProgram.iterations && currentProgram.iterations[iterationId]) {
                switchIteration(iterationId);
                renderIterationDropdown(); // Update dropdown to match selection
            }
        }

        // Program Details Functions
        let currentProgramDetails = null;
        let editingProgramNotes = null;

        function viewProgramDetails(programId) {
            const program = programs[programId];
            if (!program) return;
            
            currentProgramDetails = programId;
            
            const content = document.getElementById('programDetailsContent');
            const iterationsData = program.iterations || {};
            const completedIterations = Object.values(iterationsData).filter(iter => iter.isCompleted);
            const currentIterations = Object.values(iterationsData).filter(iter => !iter.isCompleted);
            
            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <!-- Basic Program Information -->
                        <div>
                            <h4 class="font-semibold text-lg text-gray-900 dark:text-white mb-3">Program Information</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <span class="font-medium text-gray-600 dark:text-gray-400">Duration:</span>
                                        <div class="text-gray-900 dark:text-white">${program.days} day${program.days > 1 ? 's' : ''}</div>
                                    </div>
                                    <div>
                                        <span class="font-medium text-gray-600 dark:text-gray-400">Daily Hours:</span>
                                        <div class="text-gray-900 dark:text-white">${formatTime(program.startTime)} - ${formatTime(program.endTime)}</div>
                                    </div>
                                    <div>
                                        <span class="font-medium text-gray-600 dark:text-gray-400">Total Sessions:</span>
                                        <div class="text-gray-900 dark:text-white">${program.sessions.length}</div>
                                    </div>
                                    <div>
                                        <span class="font-medium text-gray-600 dark:text-gray-400">Total Iterations:</span>
                                        <div class="text-gray-900 dark:text-white">${Object.keys(iterationsData).length}</div>
                                    </div>
                                </div>
                                ${program.startDate ? `
                                    <div>
                                        <span class="font-medium text-gray-600 dark:text-gray-400">Original Start Date:</span>
                                        <div class="text-gray-900 dark:text-white">${formatDate(program.startDate)}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Program Notes -->
                        <div>
                            <h4 class="font-semibold text-lg text-gray-900 dark:text-white mb-3">Program Notes</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${program.notes || 'No program notes available.'}</p>
                            </div>
                        </div>

                        <!-- Notable Changes -->
                        <div>
                            <h4 class="font-semibold text-lg text-gray-900 dark:text-white mb-3">Notable Changes</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${program.notableChanges || 'No notable changes documented.'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Past Iterations -->
                        <div>
                            <h4 class="font-semibold text-lg text-gray-900 dark:text-white mb-3">Past Iterations</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                ${completedIterations.length > 0 ? `
                                    <div class="space-y-3">
                                        ${Object.entries(iterationsData).filter(([id, iter]) => iter.isCompleted).map(([iterationId, iteration]) => {
                                            const scheduledItemsCount = Object.keys(iteration.schedule || {}).length;
                                            return `
                                                <div class="p-3 bg-white dark:bg-gray-800 rounded border cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors" 
                                                     onclick="openIterationInScheduleBuilder('${programId}', '${iterationId}')">
                                                    <div class="flex items-center justify-between">
                                                        <h5 class="font-medium text-gray-900 dark:text-white">${iteration.title}</h5>
                                                        <div class="flex items-center space-x-2">
                                                            <span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">Completed</span>
                                                            <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                            </svg>
                                                        </div>
                                                    </div>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${scheduledItemsCount} scheduled items</p>
                                                    <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">Click to open in Schedule Builder</p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p class="text-sm text-gray-500 dark:text-gray-400">No completed iterations yet.</p>'}
                            </div>
                        </div>

                        <!-- Current Iterations -->
                        <div>
                            <h4 class="font-semibold text-lg text-gray-900 dark:text-white mb-3">Current Iterations</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                ${currentIterations.length > 0 ? `
                                    <div class="space-y-3">
                                        ${Object.entries(iterationsData).filter(([id, iter]) => !iter.isCompleted).map(([iterationId, iteration]) => {
                                            const scheduledItemsCount = Object.keys(iteration.schedule || {}).length;
                                            return `
                                                <div class="p-3 bg-white dark:bg-gray-800 rounded border cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors" 
                                                     onclick="openIterationInScheduleBuilder('${programId}', '${iterationId}')">
                                                    <div class="flex items-center justify-between">
                                                        <h5 class="font-medium text-gray-900 dark:text-white">${iteration.title}</h5>
                                                        <div class="flex items-center space-x-2">
                                                            <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">Active</span>
                                                            <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                            </svg>
                                                        </div>
                                                    </div>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${scheduledItemsCount} scheduled items</p>
                                                    <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">Click to open in Schedule Builder</p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p class="text-sm text-gray-500 dark:text-gray-400">No active iterations.</p>'}
                            </div>
                        </div>

                        <!-- All Sessions -->
                        <div>
                            <h4 class="font-semibold text-lg text-gray-900 dark:text-white mb-3">All Sessions (${program.sessions.length})</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg max-h-64 overflow-y-auto">
                                ${program.sessions.length > 0 ? `
                                    <div class="space-y-2">
                                        ${program.sessions.map(session => `
                                            <div class="p-3 bg-white dark:bg-gray-800 rounded border">
                                                <div class="flex items-center space-x-2 mb-1">
                                                    <div class="w-3 h-3 rounded-full ${session.color}"></div>
                                                    <h5 class="font-medium text-sm text-gray-900 dark:text-white">${session.title}</h5>
                                                </div>
                                                <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                    <div><strong>Instructor:</strong> ${session.instructor}</div>
                                                    <div><strong>Duration:</strong> ${session.duration}h • <strong>Type:</strong> ${session.type}</div>
                                                    ${session.materials ? `<div><strong>Materials:</strong> ${session.materials.substring(0, 60)}${session.materials.length > 60 ? '...' : ''}</div>` : ''}
                                                </div>
                                                <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                                                    <button onclick="viewSessionDetails('${session.id}')" class="text-xs text-primary hover:text-primaryDark">
                                                        View Details
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-sm text-gray-500 dark:text-gray-400">No sessions in this program.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('programDetailsTitle').textContent = program.name;
            document.getElementById('programDetailsModal').classList.remove('hidden');
        }

        function editProgramNotes(programId) {
            const program = programs[programId];
            if (!program) return;
            
            editingProgramNotes = programId;
            
            // Initialize notes fields if they don't exist
            if (!program.notes) program.notes = '';
            if (!program.notableChanges) program.notableChanges = '';
            
            document.getElementById('editProgramNotes').value = program.notes;
            document.getElementById('editProgramNotableChanges').value = program.notableChanges;
            
            document.getElementById('programNotesModal').classList.remove('hidden');
        }

        function saveProgramNotes() {
            if (!editingProgramNotes) return;
            
            const program = programs[editingProgramNotes];
            if (!program) return;
            
            program.notes = document.getElementById('editProgramNotes').value.trim();
            program.notableChanges = document.getElementById('editProgramNotableChanges').value.trim();
            
            // Update program management view if we're currently viewing it
            if (currentView === 'programs') {
                renderProgramsManagement();
            }
            
            // Update program details if they're currently open
            if (currentProgramDetails === editingProgramNotes) {
                viewProgramDetails(editingProgramNotes);
            }
            
            document.getElementById('programNotesModal').classList.add('hidden');
            editingProgramNotes = null;
        }

        // Session library functions
        function renderSessionLibrary() {
            // Create a map of unique sessions with their associated programs
            const sessionMap = new Map();
            
            Object.values(programs).forEach(program => {
                program.sessions.forEach(session => {
                    if (sessionMap.has(session.id)) {
                        // Session already exists, add this program to its list
                        sessionMap.get(session.id).programs.push({
                            id: program.id,
                            name: program.name
                        });
                    } else {
                        // New session, create entry
                        sessionMap.set(session.id, {
                            ...session,
                            programs: [{
                                id: program.id,
                                name: program.name
                            }]
                        });
                    }
                });
            });
            
            const allSessions = Array.from(sessionMap.values());
            filterAndDisplaySessions(allSessions);
        }

        function filterAndDisplaySessions(sessions) {
            const searchTerm = document.getElementById('sessionSearch').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            
            const filteredSessions = sessions.filter(session => {
                const matchesSearch = session.title.toLowerCase().includes(searchTerm) ||
                                    session.instructor.toLowerCase().includes(searchTerm) ||
                                    session.type.toLowerCase().includes(searchTerm) ||
                                    (session.materials && session.materials.toLowerCase().includes(searchTerm)) ||
                                    (session.notes && session.notes.toLowerCase().includes(searchTerm));
                const matchesType = !typeFilter || session.type === typeFilter;
                return matchesSearch && matchesType;
            });
            
            const sessionsList = document.getElementById('allSessionsList');
            sessionsList.innerHTML = filteredSessions.map(session => {
                const programsList = session.programs.map(p => p.name).join(', ');
                const documentsCount = session.documents ? session.documents.length : 0;
                
                return `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div class="flex items-center space-x-2 mb-2">
                        <div class="w-3 h-3 rounded-full ${session.color}"></div>
                        <h3 class="font-medium text-sm">${session.title}</h3>
                        ${documentsCount > 0 ? `<span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">${documentsCount} doc${documentsCount > 1 ? 's' : ''}</span>` : ''}
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                        <div><strong>Instructor:</strong> ${session.instructor}</div>
                        <div><strong>Duration:</strong> ${session.duration} hour${session.duration > 1 ? 's' : ''}</div>
                        <div><strong>Type:</strong> ${session.type}</div>
                        <div><strong>Programs:</strong> ${programsList}</div>
                        ${session.materials ? `<div><strong>Materials:</strong> ${session.materials.substring(0, 50)}${session.materials.length > 50 ? '...' : ''}</div>` : ''}
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 flex space-x-2 flex-wrap gap-1">
                        <button onclick="viewSessionDetails('${session.id}')" class="text-primary hover:text-primaryDark text-xs">
                            View Details
                        </button>
                        <button onclick="editSessionDetails('${session.id}')" class="text-blue-600 hover:text-blue-800 text-xs">
                            Edit
                        </button>
                        ${session.programs.length > 1 ? 
                            `<button onclick="manageSessionPrograms('${session.id}')" class="text-green-600 hover:text-green-800 text-xs">
                                Manage Programs
                            </button>` : 
                            `<button onclick="switchToProgram('${session.programs[0].id}')" class="text-gray-600 hover:text-gray-800 text-xs">
                                View in Program
                            </button>`
                        }
                    </div>
                </div>
            `;
            }).join('');
        }

        // Iteration management functions
        function renderIterationTabs() {
            if (!currentProgram || !currentProgram.iterations) return;
            
            const container = document.getElementById('iterationTabsContainer');
            container.innerHTML = Object.entries(currentProgram.iterations).map(([iterationId, iteration]) => `
                <button class="iteration-tab px-3 py-1 rounded text-xs font-medium transition-colors ${
                    iterationId === currentIteration ? 
                    'bg-primary text-white' : 
                    'bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500'
                }" 
                data-iteration-id="${iterationId}">
                    ${iteration.title}
                    ${iteration.isCompleted ? ' ✓' : ''}
                </button>
            `).join('');
        }

        function renderIterationDropdown() {
            if (!currentProgram || !currentProgram.iterations) return;
            
            const dropdown = document.getElementById('iterationDropdown');
            dropdown.innerHTML = Object.entries(currentProgram.iterations).map(([iterationId, iteration]) => {
                const completedBadge = iteration.isCompleted ? ' ✓' : '';
                return `<option value="${iterationId}" ${iterationId === currentIteration ? 'selected' : ''}>${iteration.title}${completedBadge}</option>`;
            }).join('');
        }

        function switchIteration(iterationId) {
            if (!currentProgram || !currentProgram.iterations[iterationId]) return;
            
            // Save current schedule to current iteration
            if (currentProgram.iterations[currentIteration]) {
                currentProgram.iterations[currentIteration].schedule = { ...schedule };
            }
            
            // Switch to new iteration
            currentIteration = iterationId;
            schedule = { ...currentProgram.iterations[iterationId].schedule };
            
            renderIterationTabs();
            renderCalendarGrid();
        }

        function createNewIteration() {
            if (!currentProgram) return;
            
            const iterationId = `iteration-${Date.now()}`;
            const iterationTitle = `Iteration ${Object.keys(currentProgram.iterations).length}`;
            
            currentProgram.iterations[iterationId] = {
                title: iterationTitle,
                schedule: { ...currentProgram.templateOperational || {} },
                isCompleted: false
            };
            
            switchIteration(iterationId);
        }

        function editIterationTitle(iterationId) {
            editingIteration = iterationId;
            const iteration = currentProgram.iterations[iterationId];
            document.getElementById('editIterationTitle').value = iteration.title;
            document.getElementById('iterationEditModal').classList.remove('hidden');
        }

        let iterationToDelete = null;

        function confirmDeleteIteration(iterationId) {
            if (!currentProgram || !currentProgram.iterations[iterationId]) return;
            
            // Check if this is the only iteration
            const iterationCount = Object.keys(currentProgram.iterations).length;
            if (iterationCount <= 1) {
                alert('Cannot delete the last iteration. Each program must have at least one iteration.');
                return;
            }
            
            iterationToDelete = iterationId;
            const iteration = currentProgram.iterations[iterationId];
            document.getElementById('iterationNameToDelete').textContent = iteration.title;
            document.getElementById('deleteIterationModal').classList.remove('hidden');
        }

        function deleteIteration() {
            if (!iterationToDelete || !currentProgram || !currentProgram.iterations[iterationToDelete]) {
                document.getElementById('deleteIterationModal').classList.add('hidden');
                iterationToDelete = null;
                return;
            }
            
            // Save current schedule to current iteration before deletion
            if (currentProgram.iterations[currentIteration]) {
                currentProgram.iterations[currentIteration].schedule = { ...schedule };
            }
            
            // Delete the iteration
            delete currentProgram.iterations[iterationToDelete];
            
            // If we're deleting the current iteration, switch to a different one
            if (currentIteration === iterationToDelete) {
                // Find the first available iteration
                const remainingIterations = Object.keys(currentProgram.iterations);
                if (remainingIterations.length > 0) {
                    currentIteration = remainingIterations[0];
                    schedule = { ...currentProgram.iterations[currentIteration].schedule };
                } else {
                    // This shouldn't happen due to the check above, but just in case
                    currentIteration = null;
                    schedule = {};
                }
            }
            
            // Update the UI
            renderIterationTabs();
            renderIterationDropdown();
            renderCalendarGrid();
            
            // Close the modal
            document.getElementById('deleteIterationModal').classList.add('hidden');
            iterationToDelete = null;
            
            console.log(`Iteration deleted. Switched to: ${currentIteration}`);
        }

        // Additional event listeners for new features
        function setupAdditionalEventListeners() {
            // Navigation tabs
            document.getElementById('scheduleTab').addEventListener('click', () => switchView('schedule'));
            document.getElementById('programsTab').addEventListener('click', () => switchView('programs'));
            document.getElementById('sessionsTab').addEventListener('click', () => switchView('sessions'));
            
            // Program management
            document.getElementById('newProgramFromManagement').addEventListener('click', () => {
                document.getElementById('programModal').classList.remove('hidden');
            });
            
            document.getElementById('saveEditProgramBtn').addEventListener('click', () => {
                if (editingProgram) {
                    const program = programs[editingProgram];
                    program.name = document.getElementById('editProgramName').value.trim();
                    program.days = parseInt(document.getElementById('editProgramDays').value);
                    program.startTime = parseInt(document.getElementById('editProgramStartTime').value);
                    program.endTime = parseInt(document.getElementById('editProgramEndTime').value);
                    
                    renderProgramsManagement();
                    renderProgramSelect();
                    if (currentProgram && currentProgram.id === editingProgram) {
                        renderProgramDetails();
                        renderCalendar();
                    }
                    
                    document.getElementById('programEditModal').classList.add('hidden');
                    editingProgram = null;
                }
            });
            
            document.getElementById('cancelEditProgramBtn').addEventListener('click', () => {
                document.getElementById('programEditModal').classList.add('hidden');
                editingProgram = null;
            });
            
            // Session library search
            document.getElementById('sessionSearch').addEventListener('input', () => {
                if (currentView === 'sessions') {
                    renderSessionLibrary();
                }
            });
            
            document.getElementById('typeFilter').addEventListener('change', () => {
                if (currentView === 'sessions') {
                    renderSessionLibrary();
                }
            });
            
            // Iteration management - Tabs
            document.getElementById('newIterationBtn').addEventListener('click', createNewIteration);
            
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('iteration-tab')) {
                    const iterationId = e.target.dataset.iterationId;
                    switchIteration(iterationId);
                }
            });

            // Iteration management - Dropdown
            document.getElementById('iterationDropdown').addEventListener('change', (e) => {
                const iterationId = e.target.value;
                switchIteration(iterationId);
                renderIterationTabs();  // Update tabs to match dropdown
                renderIterationDropdown(); // Update dropdown to match selection
            });

            document.getElementById('newIterationDropdownBtn').addEventListener('click', () => {
                createNewIteration();
                renderIterationDropdown(); // Update dropdown after creating new iteration
            });

            document.getElementById('editIterationDropdownBtn').addEventListener('click', () => {
                if (currentIteration) {
                    editIterationTitle(currentIteration);
                }
            });

            document.getElementById('deleteIterationDropdownBtn').addEventListener('click', () => {
                if (currentIteration) {
                    confirmDeleteIteration(currentIteration);
                }
            });

            // Iteration deletion confirmation
            document.getElementById('confirmIterationDelete').addEventListener('click', () => {
                deleteIteration();
            });

            document.getElementById('cancelIterationDelete').addEventListener('click', () => {
                document.getElementById('deleteIterationModal').classList.add('hidden');
            });
            
            document.addEventListener('dblclick', (e) => {
                if (e.target.classList.contains('iteration-tab')) {
                    const iterationId = e.target.dataset.iterationId;
                    editIterationTitle(iterationId);
                }
            });
            
            document.getElementById('saveIterationTitleBtn').addEventListener('click', () => {
                if (editingIteration && currentProgram.iterations[editingIteration]) {
                    currentProgram.iterations[editingIteration].title = document.getElementById('editIterationTitle').value.trim();
                    renderIterationTabs();
                    renderIterationDropdown();  // Update dropdown too
                    document.getElementById('iterationEditModal').classList.add('hidden');
                    editingIteration = null;
                }
            });
            
            document.getElementById('cancelIterationEditBtn').addEventListener('click', () => {
                document.getElementById('iterationEditModal').classList.add('hidden');
                editingIteration = null;
            });

            // Session editing from library
            document.getElementById('saveEditSessionBtn').addEventListener('click', () => {
                saveSessionEdit();
            });
            
            document.getElementById('cancelEditSessionBtn').addEventListener('click', () => {
                document.getElementById('sessionEditModal').classList.add('hidden');
            });

            // Session details modals
            document.getElementById('editSessionDetailsBtn').addEventListener('click', () => {
                if (currentSessionDetails) {
                    document.getElementById('sessionDetailsModal').classList.add('hidden');
                    editSessionDetails(currentSessionDetails);
                }
            });

            document.getElementById('closeSessionDetailsBtn').addEventListener('click', () => {
                document.getElementById('sessionDetailsModal').classList.add('hidden');
                currentSessionDetails = null;
            });

            document.getElementById('closeSessionDetailsEditBtn').addEventListener('click', () => {
                document.getElementById('sessionDetailsEditModal').classList.add('hidden');
                currentSessionDetails = null;
            });

            document.getElementById('saveSessionDetailsBtn').addEventListener('click', () => {
                saveSessionDetails();
            });

            document.getElementById('cancelSessionDetailsEditBtn').addEventListener('click', () => {
                document.getElementById('sessionDetailsEditModal').classList.add('hidden');
                currentSessionDetails = null;
            });
        }

        // Session editing functions
        let editingSessionData = null;

        function editSessionFromLibrary(programId, sessionId) {
            const program = programs[programId];
            const session = program.sessions.find(s => s.id === sessionId);
            
            if (!session) return;
            
            editingSessionData = { programId, sessionId };
            
            document.getElementById('editSessionTitle').value = session.title;
            document.getElementById('editSessionInstructor').value = session.instructor;
            document.getElementById('editSessionDuration').value = session.duration;
            document.getElementById('editSessionType').value = session.type;
            
            document.getElementById('sessionEditModal').classList.remove('hidden');
        }

        function saveSessionEdit() {
            if (!editingSessionData) return;
            
            const { programId, sessionId } = editingSessionData;
            const program = programs[programId];
            const session = program.sessions.find(s => s.id === sessionId);
            
            if (!session) return;
            
            // Update session data
            session.title = document.getElementById('editSessionTitle').value.trim();
            session.instructor = document.getElementById('editSessionInstructor').value.trim();
            session.duration = parseFloat(document.getElementById('editSessionDuration').value);
            session.type = document.getElementById('editSessionType').value;
            
            // Update displays if this program is currently selected
            if (currentProgram && currentProgram.id === programId) {
                renderSessions();
                renderProgramDetails();
                renderCalendarGrid(); // In case session is scheduled
            }
            
            // Update session library if we're currently viewing it
            if (currentView === 'sessions') {
                renderSessionLibrary();
            }
            
            // Update programs management if we're viewing it
            if (currentView === 'programs') {
                renderProgramsManagement();
            }
            
            document.getElementById('sessionEditModal').classList.add('hidden');
            editingSessionData = null;
        }

        // Session Details Functions
        let currentSessionDetails = null;

        function findSessionById(sessionId) {
            for (const program of Object.values(programs)) {
                const session = program.sessions.find(s => s.id === sessionId);
                if (session) {
                    return { session, programIds: [program.id] };
                }
            }
            return null;
        }

        function findAllSessionPrograms(sessionId) {
            const programIds = [];
            Object.values(programs).forEach(program => {
                if (program.sessions.find(s => s.id === sessionId)) {
                    programIds.push(program.id);
                }
            });
            return programIds;
        }

        function viewSessionDetails(sessionId) {
            const result = findSessionById(sessionId);
            if (!result) return;
            
            const { session } = result;
            const allPrograms = findAllSessionPrograms(sessionId);
            currentSessionDetails = sessionId;
            
            const content = document.getElementById('sessionDetailsContent');
            const documentsHtml = session.documents && session.documents.length > 0 ? 
                session.documents.map(doc => `
                    <div class="flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-700 rounded">
                        <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-sm">${doc.name}</span>
                        <button onclick="downloadDocument('${doc.id}')" class="text-xs text-blue-600 hover:text-blue-800">Download</button>
                    </div>
                `).join('') : '<p class="text-gray-500 dark:text-gray-400 text-sm">No documents uploaded</p>';

            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="flex items-center space-x-2 mb-4">
                            <div class="w-4 h-4 rounded-full ${session.color}"></div>
                            <span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded">${session.type}</span>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">Basic Information</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-2 text-sm">
                                <div><strong>Instructor:</strong> ${session.instructor}</div>
                                <div><strong>Duration:</strong> ${session.duration} hour${session.duration > 1 ? 's' : ''}</div>
                                <div><strong>Type:</strong> ${session.type}</div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">Associated Programs</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <div class="space-y-1">
                                    ${allPrograms.map(programId => {
                                        const program = programs[programId];
                                        return `<div class="text-sm">${program.name}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">Materials</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <p class="text-sm">${session.materials || 'No materials specified'}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">Notes</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <p class="text-sm">${session.notes || 'No notes available'}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">Documents</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <div class="space-y-2">
                                    ${documentsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('sessionDetailsTitle').textContent = session.title;
            document.getElementById('sessionDetailsModal').classList.remove('hidden');
        }

        function editSessionDetails(sessionId) {
            const result = findSessionById(sessionId);
            if (!result) return;
            
            const { session } = result;
            const allPrograms = findAllSessionPrograms(sessionId);
            currentSessionDetails = sessionId;
            
            // Populate form fields
            document.getElementById('detailsEditTitle').value = session.title;
            document.getElementById('detailsEditInstructor').value = session.instructor;
            document.getElementById('detailsEditDuration').value = session.duration;
            document.getElementById('detailsEditType').value = session.type;
            document.getElementById('detailsEditMaterials').value = session.materials || '';
            document.getElementById('detailsEditNotes').value = session.notes || '';
            
            // Populate program checkboxes
            const programsContainer = document.getElementById('detailsEditPrograms');
            programsContainer.innerHTML = Object.values(programs).map(program => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${program.id}" ${allPrograms.includes(program.id) ? 'checked' : ''} 
                           class="form-checkbox text-primary">
                    <span class="text-sm">${program.name}</span>
                </label>
            `).join('');
            
            // Show existing documents
            const documentsContainer = document.getElementById('detailsEditDocumentsList');
            if (session.documents && session.documents.length > 0) {
                documentsContainer.innerHTML = session.documents.map(doc => `
                    <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-600 rounded">
                        <span class="text-sm">${doc.name}</span>
                        <button onclick="removeDocument('${doc.id}')" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
                    </div>
                `).join('');
            } else {
                documentsContainer.innerHTML = '<p class="text-gray-500 text-sm">No documents currently uploaded</p>';
            }
            
            document.getElementById('sessionDetailsEditModal').classList.remove('hidden');
        }

        function saveSessionDetails() {
            if (!currentSessionDetails) return;
            
            const result = findSessionById(currentSessionDetails);
            if (!result) return;
            
            const { session } = result;
            const currentPrograms = findAllSessionPrograms(currentSessionDetails);
            
            // Update basic session info
            session.title = document.getElementById('detailsEditTitle').value.trim();
            session.instructor = document.getElementById('detailsEditInstructor').value.trim();
            session.duration = parseFloat(document.getElementById('detailsEditDuration').value);
            session.type = document.getElementById('detailsEditType').value;
            session.materials = document.getElementById('detailsEditMaterials').value.trim();
            session.notes = document.getElementById('detailsEditNotes').value.trim();
            
            // Handle program associations
            const selectedPrograms = Array.from(document.querySelectorAll('#detailsEditPrograms input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Remove session from programs that are no longer selected
            currentPrograms.forEach(programId => {
                if (!selectedPrograms.includes(programId)) {
                    const program = programs[programId];
                    const sessionIndex = program.sessions.findIndex(s => s.id === currentSessionDetails);
                    if (sessionIndex > -1) {
                        program.sessions.splice(sessionIndex, 1);
                    }
                }
            });
            
            // Add session to newly selected programs
            selectedPrograms.forEach(programId => {
                if (!currentPrograms.includes(programId)) {
                    const program = programs[programId];
                    program.sessions.push({ ...session }); // Add a copy of the session
                }
            });
            
            // Handle file uploads (simulated)
            const fileInput = document.getElementById('detailsEditDocuments');
            if (fileInput.files.length > 0) {
                if (!session.documents) session.documents = [];
                
                Array.from(fileInput.files).forEach(file => {
                    if (session.documents.length < 3) {
                        session.documents.push({
                            id: `doc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            uploadDate: new Date().toISOString()
                        });
                    }
                });
            }
            
            // Update all displays
            if (currentProgram) {
                renderSessions();
                renderProgramDetails();
                renderCalendarGrid();
            }
            
            if (currentView === 'sessions') {
                renderSessionLibrary();
            }
            
            if (currentView === 'programs') {
                renderProgramsManagement();
            }
            
            document.getElementById('sessionDetailsEditModal').classList.add('hidden');
            currentSessionDetails = null;
        }

        function manageSessionPrograms(sessionId) {
            // For now, just open the edit modal - this could be expanded into a dedicated program management modal
            editSessionDetails(sessionId);
        }

        function removeDocument(documentId) {
            if (!currentSessionDetails) return;
            
            const result = findSessionById(currentSessionDetails);
            if (!result) return;
            
            const { session } = result;
            if (session.documents) {
                session.documents = session.documents.filter(doc => doc.id !== documentId);
            }
            
            // Refresh the documents list
            editSessionDetails(currentSessionDetails);
        }

        function downloadDocument(documentId) {
            // In a real implementation, this would download the actual file
            // For now, we'll just show a message
            alert('Document download would start here. In a real implementation, this would download the actual file.');
        }

        // Visual debug function
        function showDebugInfo() {
            if (!currentProgram) {
                alert('No program selected! Please select a program first.');
                return;
            }
            
            // Create debug info display
            let debugInfo = `SCHEDULE DEBUG INFO\n\n`;
            debugInfo += `Program: ${currentProgram.name}\n`;
            debugInfo += `Schedule Object Keys: ${Object.keys(schedule).length}\n\n`;
            
            // Group schedule by item ID
            const itemGroups = {};
            Object.keys(schedule).forEach(key => {
                const itemId = schedule[key];
                if (!itemGroups[itemId]) {
                    itemGroups[itemId] = [];
                }
                itemGroups[itemId].push(key);
            });
            
            debugInfo += `ITEMS SCHEDULED:\n`;
            Object.keys(itemGroups).forEach(itemId => {
                const session = currentProgram.sessions.find(s => s.id === itemId);
                const operational = operationalElements.find(o => o.id === itemId);
                const item = session || operational;
                const title = item ? item.title : 'UNKNOWN';
                
                debugInfo += `• ${title} (${itemId}):\n`;
                debugInfo += `  Locations: ${itemGroups[itemId].join(', ')}\n`;
                
                // Check if spans multiple days
                const days = [...new Set(itemGroups[itemId].map(loc => parseInt(loc.split('-')[0])))];
                if (days.length > 1) {
                    debugInfo += `  ❌ ISSUE: Spans multiple days: ${days.join(', ')}\n`;
                } else {
                    debugInfo += `  ✅ OK: Only in day ${days[0]}\n`;
                }
                debugInfo += `\n`;
            });
            
            alert(debugInfo);
        }

        // Debug and utility functions
        function clearSchedule() {
            if (!currentProgram) return;
            
            // Keep only operational elements from template
            const operationalSchedule = {};
            Object.keys(schedule).forEach(key => {
                const itemId = schedule[key];
                const isOperational = operationalElements.find(o => o.id === itemId);
                if (isOperational) {
                    operationalSchedule[key] = itemId;
                }
            });
            
            schedule = operationalSchedule;
            renderCalendarGrid();
            console.log('Schedule cleared - keeping only operational elements:', schedule);
        }

        function debugSchedule() {
            alert('Debug function called!');
            console.log('=== SCHEDULE DEBUG ===');
            
            if (!currentProgram) {
                console.log('No current program selected');
                return;
            }
            
            console.log('Current Program:', currentProgram.name);
            console.log('Schedule Object:', schedule);
            console.log('Schedule Keys:', Object.keys(schedule));
            
            // Group schedule by item ID to see what's scheduled where
            const itemGroups = {};
            Object.keys(schedule).forEach(key => {
                const itemId = schedule[key];
                if (!itemGroups[itemId]) {
                    itemGroups[itemId] = [];
                }
                itemGroups[itemId].push(key);
            });
            
            console.log('Items grouped by ID:');
            Object.keys(itemGroups).forEach(itemId => {
                const session = currentProgram.sessions.find(s => s.id === itemId);
                const operational = operationalElements.find(o => o.id === itemId);
                const item = session || operational;
                console.log(`  ${itemId} (${item ? item.title : 'UNKNOWN'}):`, itemGroups[itemId]);
            });
            
            // Check for horizontal spanning issues
            console.log('Checking for horizontal spanning issues...');
            Object.keys(itemGroups).forEach(itemId => {
                const locations = itemGroups[itemId];
                const days = [...new Set(locations.map(loc => parseInt(loc.split('-')[0])))];
                if (days.length > 1) {
                    console.warn(`❌ ISSUE: Item ${itemId} spans multiple days:`, days);
                } else {
                    console.log(`✅ OK: Item ${itemId} only in day ${days[0]}`);
                }
            });
        }

        // Operational element management
        let editingOperational = null;
        let operationalToDelete = null;

        function addOperationalElement() {
            document.getElementById('operationalModalTitle').textContent = 'Add Operational Element';
            document.getElementById('operationalTitle').value = '';
            document.getElementById('operationalDuration').value = '0.5';
            document.getElementById('operationalType').value = 'break';
            document.getElementById('operationalColor').value = 'bg-orange-400';
            editingOperational = null;
            document.getElementById('operationalModal').classList.remove('hidden');
        }

        function editOperationalElement(elementId) {
            const element = operationalElements.find(e => e.id === elementId);
            if (!element) return;
            
            editingOperational = elementId;
            document.getElementById('operationalModalTitle').textContent = 'Edit Operational Element';
            document.getElementById('operationalTitle').value = element.title;
            document.getElementById('operationalDuration').value = element.duration;
            document.getElementById('operationalType').value = element.type;
            document.getElementById('operationalColor').value = element.color;
            document.getElementById('operationalModal').classList.remove('hidden');
        }

        function saveOperationalElement() {
            const title = document.getElementById('operationalTitle').value.trim();
            const duration = parseFloat(document.getElementById('operationalDuration').value);
            const type = document.getElementById('operationalType').value;
            const color = document.getElementById('operationalColor').value;
            
            if (!title) {
                alert('Please enter a title for the operational element.');
                return;
            }
            
            if (editingOperational) {
                // Edit existing element
                const element = operationalElements.find(e => e.id === editingOperational);
                if (element) {
                    element.title = title;
                    element.duration = duration;
                    element.type = type;
                    element.color = color;
                }
            } else {
                // Add new element
                const newElement = {
                    id: `operational-${Date.now()}`,
                    title,
                    duration,
                    type,
                    color
                };
                operationalElements.push(newElement);
            }
            
            // Re-render operational elements
            renderOperationalElements();
            
            // Update any current schedules if the element is being used
            if (currentProgram) {
                renderCalendarGrid();
            }
            
            // Close modal
            document.getElementById('operationalModal').classList.add('hidden');
            editingOperational = null;
        }

        function deleteOperationalElement(elementId) {
            const element = operationalElements.find(e => e.id === elementId);
            if (!element) return;
            
            operationalToDelete = elementId;
            document.getElementById('operationalNameToDelete').textContent = element.title;
            document.getElementById('deleteOperationalModal').classList.remove('hidden');
        }

        function confirmDeleteOperationalElement() {
            if (!operationalToDelete) return;
            
            // Remove from operational elements array
            const index = operationalElements.findIndex(e => e.id === operationalToDelete);
            if (index > -1) {
                operationalElements.splice(index, 1);
            }
            
            // Remove from all schedules across all programs and iterations
            Object.values(programs).forEach(program => {
                if (program.iterations) {
                    Object.values(program.iterations).forEach(iteration => {
                        if (iteration.schedule) {
                            Object.keys(iteration.schedule).forEach(key => {
                                if (iteration.schedule[key] === operationalToDelete) {
                                    delete iteration.schedule[key];
                                }
                            });
                        }
                    });
                }
                
                // Also remove from template operational
                if (program.templateOperational) {
                    Object.keys(program.templateOperational).forEach(key => {
                        if (program.templateOperational[key] === operationalToDelete) {
                            delete program.templateOperational[key];
                        }
                    });
                }
            });
            
            // Remove from current schedule
            Object.keys(schedule).forEach(key => {
                if (schedule[key] === operationalToDelete) {
                    delete schedule[key];
                }
            });
            
            // Re-render
            renderOperationalElements();
            if (currentProgram) {
                renderCalendarGrid();
            }
            
            // Close modal
            document.getElementById('deleteOperationalModal').classList.add('hidden');
            operationalToDelete = null;
        }

        // =========================
        // DATA IMPORT/EXPORT FUNCTIONS
        // =========================

        // Export all data as JSON backup
        function exportAllData() {
            const backup = {
                programs: programs,
                operationalElements: operationalElements,
                currentProgram: currentProgram ? currentProgram.id : null,
                currentIteration: currentIteration,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `hlsee-schedule-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Import CSV data (programs and sessions)
        function importCSVData(csvContent, type) {
            try {
                const lines = csvContent.split('\n').filter(line => line.trim() !== '');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                if (type === 'programs') {
                    importProgramsFromCSV(lines, headers);
                } else if (type === 'sessions') {
                    importSessionsFromCSV(lines, headers);
                }
                
                // Update displays
                renderProgramSelect();
                if (currentView === 'programs') {
                    renderProgramsManagement();
                }
                if (currentView === 'sessions') {
                    renderSessionLibrary();
                }
                
                showNotification('Data imported successfully!', 'success');
            } catch (error) {
                console.error('Import error:', error);
                showNotification('Error importing data: ' + error.message, 'error');
            }
        }

        function importProgramsFromCSV(lines, headers) {
            // Expected CSV format: Program Name, Duration (Days), Start Time, End Time, Notes
            const requiredHeaders = ['program name', 'duration', 'start time', 'end time'];
            const missingHeaders = requiredHeaders.filter(h => 
                !headers.some(header => header.toLowerCase().includes(h))
            );
            
            if (missingHeaders.length > 0) {
                throw new Error(`Missing required columns: ${missingHeaders.join(', ')}`);
            }
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < 4) continue;
                
                const programData = {
                    name: values[0]?.trim(),
                    days: parseInt(values[1]) || 1,
                    startTime: parseInt(values[2]) || 8,
                    endTime: parseInt(values[3]) || 18,
                    notes: values[4]?.trim() || '',
                    notableChanges: values[5]?.trim() || ''
                };
                
                if (!programData.name) continue;
                
                const newProgram = {
                    id: `program-${Date.now()}-${i}`,
                    ...programData,
                    sessions: [],
                    iterations: {
                        'current': {
                            title: 'Current',
                            schedule: {},
                            isCompleted: false
                        }
                    }
                };
                
                programs[newProgram.id] = newProgram;
            }
        }

        function importSessionsFromCSV(lines, headers) {
            // Expected CSV format: Session Title, Instructor, Duration, Type, Materials, Notes, Program Name(s)
            const requiredHeaders = ['session title', 'instructor', 'duration', 'type'];
            const missingHeaders = requiredHeaders.filter(h => 
                !headers.some(header => header.toLowerCase().includes(h))
            );
            
            if (missingHeaders.length > 0) {
                throw new Error(`Missing required columns: ${missingHeaders.join(', ')}`);
            }
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < 4) continue;
                
                const sessionData = {
                    title: values[0]?.trim(),
                    instructor: values[1]?.trim(),
                    duration: parseFloat(values[2]) || 1.5,
                    type: values[3]?.trim() || 'lecture',
                    materials: values[4]?.trim() || '',
                    notes: values[5]?.trim() || '',
                    programNames: values[6]?.trim().split(';').map(p => p.trim()) || []
                };
                
                if (!sessionData.title || !sessionData.instructor) continue;
                
                const newSession = {
                    id: `session-${Date.now()}-${i}`,
                    title: sessionData.title,
                    instructor: sessionData.instructor,
                    duration: sessionData.duration,
                    type: sessionData.type,
                    materials: sessionData.materials || null,
                    notes: sessionData.notes || null,
                    documents: [],
                    color: getRandomColor()
                };
                
                // Add session to specified programs or all programs if none specified
                const targetPrograms = sessionData.programNames.length > 0 
                    ? Object.values(programs).filter(p => 
                        sessionData.programNames.some(name => 
                            p.name.toLowerCase().includes(name.toLowerCase())
                        )
                    )
                    : Object.values(programs);
                
                targetPrograms.forEach(program => {
                    program.sessions.push({ ...newSession });
                });
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(item => item.replace(/^"|"$/g, ''));
        }

        // Import JSON backup
        function importJSONData(jsonContent) {
            try {
                const data = JSON.parse(jsonContent);
                
                // Validate data structure
                if (!data.programs || !data.operationalElements) {
                    throw new Error('Invalid backup file format');
                }
                
                // Confirm before overwriting
                if (Object.keys(programs).length > 2) { // More than sample programs
                    if (!confirm('This will replace all current data. Are you sure?')) {
                        return;
                    }
                }
                
                // Import data
                programs = { ...data.programs };
                if (data.operationalElements && Array.isArray(data.operationalElements)) {
                    // Merge operational elements, avoiding duplicates
                    data.operationalElements.forEach(newElement => {
                        const exists = operationalElements.find(e => e.id === newElement.id);
                        if (!exists) {
                            operationalElements.push(newElement);
                        }
                    });
                }
                
                // Reset current program and iteration
                currentProgram = null;
                currentIteration = 'current';
                schedule = {};
                
                // Update displays
                renderProgramSelect();
                hideProgramElements();
                if (currentView === 'programs') {
                    renderProgramsManagement();
                }
                if (currentView === 'sessions') {
                    renderSessionLibrary();
                }
                
                showNotification('Backup imported successfully!', 'success');
            } catch (error) {
                console.error('Import error:', error);
                showNotification('Error importing backup: ' + error.message, 'error');
            }
        }

        // Show notification to user
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
                type === 'success' 
                    ? 'bg-green-600 text-white' 
                    : 'bg-red-600 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Create sample CSV templates for download
        function downloadCSVTemplate(type) {
            let csvContent = '';
            let filename = '';
            
            if (type === 'programs') {
                csvContent = `Program Name,Duration (Days),Start Time,End Time,Notes,Notable Changes
"Executive Leadership Program",3,9,17,"3-day intensive program","Updated curriculum 2024"
"Legal Writing Workshop",1,10,16,"Single day workshop","New instructor added"
"Contract Law Seminar",2,8,18,"Two-day seminar series","Expanded case studies"`;
                filename = 'programs-template.csv';
            } else if (type === 'sessions') {
                csvContent = `Session Title,Instructor,Duration,Type,Materials,Notes,Program Names
"Introduction to Contract Law","Prof. Smith",1.5,lecture,"Casebook Ch. 1-3","Cover basic principles","Legal Writing Workshop;Contract Law Seminar"
"Negotiation Strategies","Dr. Johnson",2,workshop,"Role-play scenarios","Interactive session","Executive Leadership Program"
"Legal Research Methods","Ms. Davis",1,lab,"Research databases","Hands-on practice","Legal Writing Workshop"`;
                filename = 'sessions-template.csv';
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Quick import helper for real data
        function quickImportProgram() {
            const name = prompt("Program Name:");
            if (!name) return;
            
            const days = parseInt(prompt("Duration (days):", "3"));
            const startTime = parseInt(prompt("Start Hour (24h format):", "9"));
            const endTime = parseInt(prompt("End Hour (24h format):", "17"));
            
            if (isNaN(days) || isNaN(startTime) || isNaN(endTime) || startTime >= endTime) {
                alert("Invalid time values entered.");
                return;
            }
            
            const newProgram = {
                id: `program-${Date.now()}`,
                name,
                days,
                startTime,
                endTime,
                sessions: [],
                iterations: {
                    'current': {
                        title: 'Current',
                        schedule: {},
                        isCompleted: false
                    }
                }
            };
            
            programs[newProgram.id] = newProgram;
            renderProgramSelect();
            
            // Select the new program
            document.getElementById('programSelect').value = newProgram.id;
            selectProgram(newProgram.id);
            
            showNotification(`Program "${name}" created successfully!`, 'success');
        }

        function setupDataImportExportListeners() {
            // Export data button
            document.getElementById('exportDataBtn').addEventListener('click', () => {
                exportAllData();
            });

            // Import data button
            document.getElementById('importDataBtn').addEventListener('click', () => {
                showImportModal();
            });
        }

        // Show import options modal
        function showImportModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Import Data</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium mb-2">Import from File</h4>
                            <div class="space-y-2">
                                <button onclick="importFromFile('json')" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                                    📄 Import JSON Backup
                                </button>
                                <button onclick="importFromFile('programs-csv')" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                                    📊 Import Programs CSV
                                </button>
                                <button onclick="importFromFile('sessions-csv')" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                                    📚 Import Sessions CSV
                                </button>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-medium mb-2">Download Templates</h4>
                            <div class="space-y-2">
                                <button onclick="downloadCSVTemplate('programs')" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
                                    📋 Download Programs Template
                                </button>
                                <button onclick="downloadCSVTemplate('sessions')" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
                                    📋 Download Sessions Template
                                </button>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-medium mb-2">Quick Start</h4>
                            <button onclick="quickImportProgram(); closeImportModal();" class="w-full bg-primary hover:bg-primaryDark text-white px-4 py-2 rounded text-sm">
                                ⚡ Quick Create Program
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button onclick="closeImportModal()" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded text-base">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentImportModal = modal;
        }

        function closeImportModal() {
            if (window.currentImportModal) {
                document.body.removeChild(window.currentImportModal);
                window.currentImportModal = null;
            }
        }

        function importFromFile(type) {
            const input = document.createElement('input');
            input.type = 'file';
            
            if (type === 'json') {
                input.accept = '.json';
            } else {
                input.accept = '.csv';
            }
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    
                    try {
                        if (type === 'json') {
                            importJSONData(content);
                        } else if (type === 'programs-csv') {
                            importCSVData(content, 'programs');
                        } else if (type === 'sessions-csv') {
                            importCSVData(content, 'sessions');
                        }
                        closeImportModal();
                    } catch (error) {
                        showNotification('Error reading file: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            init();
            setupAdditionalEventListeners();
            setupOperationalElementListeners();
            setupDataImportExportListeners();
        });

        function setupOperationalElementListeners() {
            // Add operational element
            document.getElementById('addOperationalBtn').addEventListener('click', addOperationalElement);
            
            // Save operational element
            document.getElementById('saveOperationalBtn').addEventListener('click', saveOperationalElement);
            
            // Cancel operational element
            document.getElementById('cancelOperationalBtn').addEventListener('click', () => {
                document.getElementById('operationalModal').classList.add('hidden');
                editingOperational = null;
            });
            
            // Confirm delete operational element
            document.getElementById('confirmOperationalDelete').addEventListener('click', confirmDeleteOperationalElement);
            
            // Cancel delete operational element
            document.getElementById('cancelOperationalDelete').addEventListener('click', () => {
                document.getElementById('deleteOperationalModal').classList.add('hidden');
                operationalToDelete = null;
            });

            // Program details modals
            document.getElementById('editProgramDetailsBtn').addEventListener('click', () => {
                if (currentProgramDetails) {
                    editProgram(currentProgramDetails);
                    document.getElementById('programDetailsModal').classList.add('hidden');
                }
            });

            document.getElementById('closeProgramDetailsBtn').addEventListener('click', () => {
                document.getElementById('programDetailsModal').classList.add('hidden');
                currentProgramDetails = null;
            });

            // Program notes modals
            document.getElementById('closeProgramNotesBtn').addEventListener('click', () => {
                document.getElementById('programNotesModal').classList.add('hidden');
                editingProgramNotes = null;
            });

            document.getElementById('saveProgramNotesBtn').addEventListener('click', () => {
                saveProgramNotes();
            });

            document.getElementById('cancelProgramNotesBtn').addEventListener('click', () => {
                document.getElementById('programNotesModal').classList.add('hidden');
                editingProgramNotes = null;
            });
        }
    </script>
</body>
</html>
